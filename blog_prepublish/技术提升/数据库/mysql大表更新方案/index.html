<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MySql大表更新方案 | luolin1024</title><meta name=keywords content="数据库/Mysql"><meta name=description content="前言 随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更"><meta name=author content="luolin"><link rel=canonical href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E5%A4%A7%E8%A1%A8%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/><script defer src=https://blogcounter.luolin.us.kg/script.js data-website-id=c8850e2c-16aa-465e-aa6f-5392c9397317></script>
<script src=/js/umami-stats.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script>
<link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luolin1024.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://luolin1024.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luolin1024.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://luolin1024.github.io/apple-touch-icon.png><link rel=mask-icon href=https://luolin1024.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><html><head><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css><style>body{font-family:lxgw wenkai lite,sans-serif;font-family:lxgw wenkai screen,sans-serif}</style></head></html><meta property="og:title" content="MySql大表更新方案"><meta property="og:description" content="前言 随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更"><meta property="og:type" content="article"><meta property="og:url" content="https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E5%A4%A7%E8%A1%A8%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/"><meta property="article:section" content="blog_prepublish"><meta property="article:published_time" content="2024-02-21T11:30:51+08:00"><meta property="article:modified_time" content="2024-03-21T00:48:56+08:00"><meta property="og:site_name" content="luolin的博客"><meta name=twitter:card content="summary"><meta name=twitter:title content="MySql大表更新方案"><meta name=twitter:description content="前言 随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog_prepublishes","item":"https://luolin1024.github.io/blog_prepublish/"},{"@type":"ListItem","position":2,"name":"MySql大表更新方案","item":"https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E5%A4%A7%E8%A1%A8%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MySql大表更新方案","name":"MySql大表更新方案","description":"前言 随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更","keywords":["数据库/Mysql"],"articleBody":"前言\n随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更，包括创建表、添加字段、添加索引、修改字段属性等。在数据量大不大的情况下，执行DDL都很快，对业务基本没啥影响，但是数据量大的情况，而且我们业务做了读写分离，接入了实时数仓，这时DDL变更就是一个的难题，需要综合各方业务全盘考虑。下面就聊聊这些年我公司在里面，MySQL中的DDL执行方式的变化、大表DDL该如何选择以及DDL执行过程监控。\nMySQL中的DDL DDL概述 MySQL中的DDL语句形式比较多，概括一下有以下几类：CREATE，ALTER，DROP，RENAME，TRUNCATE。这些操作都是隐式提交且原子性，要么成功，要么失败，在MySQL 8.0之前DDL操作是不记录日志的。今天就聊一下跟系统版本发布相关的数据库结构变更，主要就是ALTER TABLE变更了，DDL变更流程普通的DML变更是类似的，如下所示 注：这里涉及MySQL基础知识，还不知道的朋友翻看下我MySQL基础章节即可。在早期的MySQL版本，DDL变更都会导致全表被锁，阻塞表上的DML操作，影响业务正常运行，好的一点就是，随着MySQL版本的迭代，DDL的执行方式也在变化。\nMetaData元数据 MySQL的元数据（MetaData）跟其他的RDBMS数据库一样的，描述的对象的结构信息，存储在information_schema架构下，例如常见的TABLES、COLUMNS等，下面例子是创建一个表crm_users，MySQL会自动往Information_schema.tables和columns等相关数据字典表中插入数据，这些数据称为元数据，一般都是静态化，只有表上发生了DDL操作才会实时更新。 MetaData Lock MySQL利用MetaData Lock来管理对象的访问，保证数据的一致性，对于一些核心业务表，表上DML操作比较频繁，这个时候添加字段可能会触发MetaData Lock。 可以看到Waiting for table metadata lock等待事件，thread 155正在执行alter table等待thread 154执行的select释放锁，因为DML在执行期间会持有SHARED_READ锁，要执行DDL时获取SHARED_UPGRADABLE（共享可升级锁，缩写为SU，允许并发更新和读同一个表）锁成功，但是获取EXCLUSIVE MetaData Lock锁失败，处于暂挂PENDING状态。\nDDL执行方式 从MySQL官方文档可以看到，ALTER TABLE的选项很多，跟性能相关的选项主要有ALGORITHM和LOCK。 ALGORITHM OPTION DESCRIPTION COPY MySQL早期的变更方式，需要创建修改后的临时表，然后按数据行拷贝原表数据到临时表，做rename重命名来完成创建，在此期间不允许并发DML操作，原表是可读的，不可写，同时需要额外一倍的磁盘空间。 INPLACE 直接在原表上进行修改，不需创建临时表拷贝数据及重命名，原表会持有Exclusive Metadata Lock，通常是允许并发DML操作。 INSTANT MySQL 5.8开始支持，只修改数据字典中的元数据，表数据不受影响，执行期间没有Exclusive Metadata Lock，允许并发的DML操作。 从这张表可以看到，MySQL对于DDL执行方式一直在做优化，目的就是为了提高DDL执行效率，减少锁等待，不影响表数据，同时不影响正常的DML操作。LOCK选项\nLOCK OPTiON DESCRIPTION DEFAULT 默认模式：MySQL根据运行情况，在尽量不锁表的情况下自动选择LOCK模式。 NONE 无锁：允许Online DDL期间进行并发读写操作，如果Online DDL操作不支持对表并发DML操作，则DDL操作失败，对表修改无效。 SHARED 共享锁：Online DDL操作期间不影响读取，阻塞写入。 EXCLUSIVE 排它锁：Online DDL操作期间不允许对锁表进行任何操作。 下面举例说明下这几种方式的执行过程，先创建测试表，制造一些数据。 COPY COPY方式的变更流程如下： 根据业务需要，需要在crm_users添加一个字段user_type，采用COPY方式执行变更。 从执行过程及profile可以看出，通过COPY方式会创建临是表#sql-564_85，获取System Lock，拷贝数据到临时表，最后做rename表名切换，释放Lock资源，在执行期间不支持并发DML操作。\nINPLACE INPLACE方式是在原表上直接修改，对于添加索引、添加/删除列、修改字段NULL/NOT NULL属性等操作，需要修改MySQL内部的数据记录，需要重建表（Rebuild Table）。 从执行过程可以看到，需要获取Exclusive Metadata Lock，修改表数据，释放Lock，在执行期间支持并发DML操作。\nINSTANT MySQL 5.8开始推出的方式，DDL只修改数据字典中的元数据，表数据不受影响，没有Exclusive Metadata Lock，允许并发的DML操作，支持的DDL变更是有限制的，目前主要包括添加字段，添加/删除生成列，修改ENUM或SET列，改变索引类型以及重命名表。 比对下这三种方式的执行效率\n执行方式/项目 数据量(w) 执行时间(s) 重建表 修改MetaData 修改Data 允许并发DML COPY 650 29.89 YES No Yes No INPLACE 650 10.56 YES No Yes Yes INSTANT 650 0.19 No Yes No Yes ONLINE DDL 截止MySQL 8.0，OnLine DDL有三种方式COPY，INPLACE，INSTANT，MySQL会自动根据执行的DDL选择使用哪种方式，一般会优先选择INSTANT方式，如果不支持，就选择INPLANCE方式，再不支持就只能选择COPY方式了。MySQL官方文档也给出了Online DDL的支持矩阵，列下常用的DDL操作，对比项主要包括是否重建表，允许并发的DML操作以及只修改元数据，表数据不受影响。\nOperation Instant In Place Copy Rebuilds Table Permits Concurrent DML Only Modifies Metadata Adding a column Yes Yes* Yes No* Yes* Yes Dropping a column No Yes Yes Yes Yes No Renaming a column No Yes Yes No Yes Yes Setting a column default value Yes Yes Yes No Yes Yes Dropping the column default value Yes Yes Yes No Yes Yes Changing the auto-increment value No Yes Yes No Yes No Making a column NULL No Yes Yes Yes* Yes No Making a column NOT NULL No Yes Yes Yes* Yes No Adding a primary key No Yes* Yes Yes* Yes No Dropping a primary key No No Yes Yes No No Creating or adding a secondary index No Yes Yes No Yes No Dropping an index No Yes Yes No Yes Yes Renaming an index No Yes Yes No No No Adding a FULLTEXT index No Yes* Yes No* No No 大表DDL方案 在实际业务系统中，业务发展比较快，表的数据量比较大，业务层面又做了读写分离，同时会将MySQL数据实时同步到数据仓库（包括实时数仓和离线数仓），实际的数据库架构如下。 假设这是一个交易系统数据库，订单表booking有8000w数据，且接入到了实时和离线仓库，根据业务需要，在订单表booking添加一个字段，在MySQL 5.7之前添加字段属于高危操作，需要充分考虑对业务的影响，主要存在于两个方面：\n在读写分离场景，主从同步延迟导致业务数据不一致 实时数仓ADB不允许源端MySQL表重命名，如果通过COPY方式或者pt-osc、gh-ost等工具都会rename表名，那么就需要从数仓删除该表，重新配置同步（全量 + 增量），会影响数仓业务 ONLINE DDL方式 对于MySQL 5.6到5.7的版本，可以使用OnLine DDL的方式变更，对于大表来说，执行时间会很长，好处是在Master上DML操作不受影响，但是会导致主从延时。假如Master上添加字段执行了20分钟，相应的Slave也要执行20分钟，在这期间Slave一直处于延迟状态，会造成业务数据不一致，比如用户在Master下单成功，由于Slave延迟查询不到订单信息，用户误以为网络原因没有下单成功，又下了一单，导致重复下单的情况。这种方式会导致主从延迟，但是不会影响实时数仓的业务，根据业务情况，只能选择在业务低峰期执行了。\npt-osc工具 为了解决DDL变更导致主从延时对业务的影响，会想到用大表变更利器pt-osc（pt-online-schema-change）或者gh-ost工具来做，这两个工具执行过程及原理大同小异，变更流程如下（不考虑外键，按照MySQL规范不允许使用外键）： 创建一个新的表，表结构为修改后的数据表，用于从源数据表向新表中导入数据。 在源表上创建触发器，用于记录从拷贝数据开始之后，对源数据表继续进行数据修改的操作记录下来，用于数据拷贝结束后，执行这些操作，保证数据不会丢失。 拷贝数据，从源数据表中拷贝数据到新表中。 修改外键相关的子表，根据修改后的数据，修改外键关联的子表。 rename源数据表为old表，把新表rename为源表名，并将old表删除。 删除触发器。 执行pt-osc的时候也需要获取一个Exclusive Metadata Lock，如果在此期间表上有DML操作正在进行，pt-osc操作会一直处于暂挂PENDING状态，这个时候表上正常DML操作都会被阻塞，MySQL活动连接数瞬间暴涨，CPU使用率100%，依赖的该表的接口都会报错，所以要选择在业务低峰期执行，同时做好MetaData Lock锁的监控以便业务不受影响，来看一个例子： D=trade, t=booking：数据库trade，表名booking。–chunk-size=1000：每次拷贝的数据行数。–max-log = 1：确保从库延迟不超过1s，超过就停止拷贝数据。–check-interval=2：表示等待2s之后继续拷贝数据。–recursion-method=“hosts”：如果不是使用默认端口3306，那么使用hosts方式来查找从库更可靠。一般MySQL binlog格式都是ROW，pt-osc在拷贝数据的过程也会产生大量的binlog，也可能导致主从延时，需要控制好每次拷贝数据的大小和频率，在执行期间，也会降低DML的并发度。\nMySQL 8.0变更方式 用过Oracle的都知道，DDL变更都是修改元数据，上亿的表在Oracle中DDL变更都是瞬间完成。令人激动的是，MySQL 8.0也推出了INSTANT方式，真正的只修改MetaData，不影响表数据，所以它的执行效率跟表大小几乎没有关系。建议新系统上线用MySQL的话尽量使用MySQL 8.0，老的数据库也可以升级到MySQL 8.0获取更好的性能。官方文档对INSTANT的解释：INSTANT: _Operations only modify metadata in the data dictionary. No exclusive metadata locks are taken on the table during preparation and execution, and table data is unaffected, making operations instantaneous. Concurrent DML is permitted. (Introduced in MySQL 8.0.12)_既要解决主从同步，又要解决rename数仓不同步的问题，目前只有INSTANT方式满足需求了。\n监控DDL执行进度 在大表执行DDL变更的时候，非常关心它的执行进度，MySQL 5.7之前是没有好的工具去监控，基本只能坐等了。在MySQL 8.0可以通过开启performance_schema，打开events_stages_current事件进行监控。 总结 DDL在业务系统版本迭代的过程是必不可少的，如何在不影响业务以及外围系统的情况下，实现DDL的平滑变更，是需要综合个系统特性考虑的，评估出重要性和优先级，同时也要掌握不同MySQL版本DDL执行方式，以便我们做更好的选择。例如上面提到了，目前我在大数据团队，我们的业务都做了读写分离，同时接入实时数仓，数仓不支持rename操作，这时就可以选择在业务低峰期使用ONLINE DDL的方式执行，对业务系统影响最小，同时不影响数仓。\n","wordCount":"4560","inLanguage":"en","datePublished":"2024-02-21T11:30:51+08:00","dateModified":"2024-03-21T00:48:56+08:00","author":{"@type":"Person","name":"luolin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E5%A4%A7%E8%A1%A8%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/"},"publisher":{"@type":"Organization","name":"luolin1024","logo":{"@type":"ImageObject","url":"https://luolin1024.github.io/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luolin1024.github.io accesskey=h title="luolin的博客 (Alt + H)">luolin的博客</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://luolin1024.github.io/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://luolin1024.github.io/archives/ title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://luolin1024.github.io/search/ title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://luolin1024.github.io/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://luolin1024.github.io/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://luolin1024.github.io/links title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luolin1024.github.io>Home</a>&nbsp;»&nbsp;<a href=https://luolin1024.github.io/blog_prepublish/>Blog_prepublishes</a></div><h1 class="post-title entry-hint-parent">MySql大表更新方案</h1><div class=post-meta><span title='2024-02-21 11:30:51 +0800 +0800'>2024-02-21</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;4560 words&nbsp;·&nbsp;luolin
本文总阅读量 <span id=umami_value_page_pv></span> 次
本文总访客量 <span id=umami_value_page_uv></span> 人</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#mysql%e4%b8%ad%e7%9a%84ddl aria-label=MySQL中的DDL>MySQL中的DDL</a><ul><li><a href=#ddl%e6%a6%82%e8%bf%b0 aria-label=DDL概述>DDL概述</a></li><li><a href=#metadata%e5%85%83%e6%95%b0%e6%8d%ae aria-label=MetaData元数据>MetaData元数据</a></li><li><a href=#metadata-lock aria-label="MetaData Lock">MetaData Lock</a></li></ul></li><li><a href=#ddl%e6%89%a7%e8%a1%8c%e6%96%b9%e5%bc%8f aria-label=DDL执行方式>DDL执行方式</a><ul><li><a href=#copy aria-label=COPY>COPY</a></li><li><a href=#inplace aria-label=INPLACE>INPLACE</a></li><li><a href=#instant aria-label=INSTANT>INSTANT</a></li><li><a href=#online-ddl aria-label="ONLINE DDL">ONLINE DDL</a></li></ul></li><li><a href=#%e5%a4%a7%e8%a1%a8ddl%e6%96%b9%e6%a1%88 aria-label=大表DDL方案>大表DDL方案</a><ul><li><a href=#online-ddl%e6%96%b9%e5%bc%8f aria-label="ONLINE DDL方式">ONLINE DDL方式</a></li><li><a href=#pt-osc%e5%b7%a5%e5%85%b7 aria-label=pt-osc工具>pt-osc工具</a></li><li><a href=#mysql-80%e5%8f%98%e6%9b%b4%e6%96%b9%e5%bc%8f aria-label="MySQL 8.0变更方式">MySQL 8.0变更方式</a></li></ul></li><li><a href=#%e7%9b%91%e6%8e%a7ddl%e6%89%a7%e8%a1%8c%e8%bf%9b%e5%ba%a6 aria-label=监控DDL执行进度>监控DDL执行进度</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><strong>前言</strong></p><p>随着业务的发展，用户对系统需求变得越来越多，这就要求系统能够快速更新迭代以满足业务需求，通常系统版本发布时，都要先执行数据库的DDL变更，包括创建表、添加字段、添加索引、修改字段属性等。在数据量大不大的情况下，执行DDL都很快，对业务基本没啥影响，但是数据量大的情况，而且我们业务做了读写分离，接入了实时数仓，这时DDL变更就是一个的难题，需要综合各方业务全盘考虑。下面就聊聊这些年我公司在里面，MySQL中的DDL执行方式的变化、大表DDL该如何选择以及DDL执行过程监控。</p><h2 id=mysql中的ddl>MySQL中的DDL<a hidden class=anchor aria-hidden=true href=#mysql中的ddl>#</a></h2><h3 id=ddl概述>DDL概述<a hidden class=anchor aria-hidden=true href=#ddl概述>#</a></h3><p>MySQL中的DDL语句形式比较多，概括一下有以下几类：CREATE，ALTER，DROP，RENAME，TRUNCATE。这些操作都是隐式提交且原子性，要么成功，要么失败，在MySQL 8.0之前DDL操作是不记录日志的。今天就聊一下跟系统版本发布相关的数据库结构变更，主要就是ALTER TABLE变更了，DDL变更流程普通的DML变更是类似的，如下所示<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270769-3794b3e3-efbf-48ff-89e0-a729036b37ca.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270769-3794b3e3-efbf-48ff-89e0-a729036b37ca.webp alt></a></div>注：这里涉及MySQL基础知识，还不知道的朋友翻看下我MySQL基础章节即可。在早期的MySQL版本，DDL变更都会导致全表被锁，阻塞表上的DML操作，影响业务正常运行，好的一点就是，随着MySQL版本的迭代，DDL的执行方式也在变化。</p><h3 id=metadata元数据>MetaData元数据<a hidden class=anchor aria-hidden=true href=#metadata元数据>#</a></h3><p>MySQL的元数据（MetaData）跟其他的RDBMS数据库一样的，描述的对象的结构信息，存储在information_schema架构下，例如常见的TABLES、COLUMNS等，下面例子是创建一个表crm_users，MySQL会自动往Information_schema.tables和columns等相关数据字典表中插入数据，这些数据称为元数据，一般都是静态化，只有表上发生了DDL操作才会实时更新。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270744-70dca835-0f26-4c43-a22e-a7130b1fce0c.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270744-70dca835-0f26-4c43-a22e-a7130b1fce0c.webp alt></a></div></p><h3 id=metadata-lock>MetaData Lock<a hidden class=anchor aria-hidden=true href=#metadata-lock>#</a></h3><p>MySQL利用MetaData Lock来管理对象的访问，保证数据的一致性，对于一些核心业务表，表上DML操作比较频繁，这个时候添加字段可能会触发MetaData Lock。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270735-432b356f-9823-4b19-a63e-6ab33fbd13b4.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270735-432b356f-9823-4b19-a63e-6ab33fbd13b4.webp alt></a></div><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270752-239f73f6-af67-498e-b8a9-1951389d45c3.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270752-239f73f6-af67-498e-b8a9-1951389d45c3.webp alt></a></div>可以看到Waiting for table metadata lock等待事件，thread 155正在执行alter table等待thread 154执行的select释放锁，因为DML在执行期间会持有SHARED_READ锁，要执行DDL时获取SHARED_UPGRADABLE（共享可升级锁，缩写为SU，允许并发更新和读同一个表）锁成功，但是获取EXCLUSIVE MetaData Lock锁失败，处于暂挂PENDING状态。</p><h2 id=ddl执行方式>DDL执行方式<a hidden class=anchor aria-hidden=true href=#ddl执行方式>#</a></h2><p>从MySQL官方文档可以看到，ALTER TABLE的选项很多，跟性能相关的选项主要有ALGORITHM和LOCK。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270774-13ae05d2-dde4-4bd5-9653-803e90f90342.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121270774-13ae05d2-dde4-4bd5-9653-803e90f90342.webp alt></a></div></p><table><thead><tr><th>ALGORITHM OPTION</th><th>DESCRIPTION</th></tr></thead><tbody><tr><td>COPY</td><td>MySQL早期的变更方式，需要创建修改后的临时表，然后按数据行拷贝原表数据到临时表，做rename重命名来完成创建，在此期间不允许并发DML操作，原表是可读的，不可写，同时需要额外一倍的磁盘空间。</td></tr><tr><td>INPLACE</td><td>直接在原表上进行修改，不需创建临时表拷贝数据及重命名，原表会持有Exclusive Metadata Lock，通常是允许并发DML操作。</td></tr><tr><td>INSTANT</td><td>MySQL 5.8开始支持，只修改数据字典中的元数据，表数据不受影响，执行期间没有Exclusive Metadata Lock，允许并发的DML操作。</td></tr></tbody></table><p>从这张表可以看到，MySQL对于DDL执行方式一直在做优化，目的就是为了提高DDL执行效率，减少锁等待，不影响表数据，同时不影响正常的DML操作。<strong>LOCK选项</strong></p><table><thead><tr><th>LOCK OPTiON</th><th>DESCRIPTION</th></tr></thead><tbody><tr><td>DEFAULT</td><td>默认模式：MySQL根据运行情况，在尽量不锁表的情况下自动选择LOCK模式。</td></tr><tr><td>NONE</td><td>无锁：允许Online DDL期间进行并发读写操作，如果Online DDL操作不支持对表并发DML操作，则DDL操作失败，对表修改无效。</td></tr><tr><td>SHARED</td><td>共享锁：Online DDL操作期间不影响读取，阻塞写入。</td></tr><tr><td>EXCLUSIVE</td><td>排它锁：Online DDL操作期间不允许对锁表进行任何操作。</td></tr></tbody></table><p>下面举例说明下这几种方式的执行过程，先创建测试表，制造一些数据。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271090-12891dff-ea5a-487b-a885-98e2a4153178.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271090-12891dff-ea5a-487b-a885-98e2a4153178.webp alt></a></div></p><h3 id=copy>COPY<a hidden class=anchor aria-hidden=true href=#copy>#</a></h3><p>COPY方式的变更流程如下：<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271158-a092c803-e898-449d-bd7f-ff62ddc548e8.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271158-a092c803-e898-449d-bd7f-ff62ddc548e8.webp alt></a></div>根据业务需要，需要在crm_users添加一个字段user_type，采用COPY方式执行变更。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271193-0ef3f2e0-27eb-43c5-b663-557412a0b699.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271193-0ef3f2e0-27eb-43c5-b663-557412a0b699.webp alt></a></div><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271152-690ec1fe-62b9-4baa-8123-ee3278fe29e7.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271152-690ec1fe-62b9-4baa-8123-ee3278fe29e7.webp alt></a></div>从执行过程及profile可以看出，通过COPY方式会创建临是表#sql-564_85，获取System Lock，拷贝数据到临时表，最后做rename表名切换，释放Lock资源，在执行期间不支持并发DML操作。</p><h3 id=inplace>INPLACE<a hidden class=anchor aria-hidden=true href=#inplace>#</a></h3><p>INPLACE方式是在原表上直接修改，对于添加索引、添加/删除列、修改字段NULL/NOT NULL属性等操作，需要修改MySQL内部的数据记录，需要重建表（Rebuild Table）。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271183-2352e597-4351-40ff-b62a-29bdcce6a68e.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271183-2352e597-4351-40ff-b62a-29bdcce6a68e.webp alt></a></div><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271550-df86b4e6-91eb-49af-8aca-aedc0289f464.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271550-df86b4e6-91eb-49af-8aca-aedc0289f464.webp alt></a></div><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271586-571a9d16-f1eb-4da9-bb20-10df3bb4a5f3.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271586-571a9d16-f1eb-4da9-bb20-10df3bb4a5f3.webp alt></a></div>从执行过程可以看到，需要获取Exclusive Metadata Lock，修改表数据，释放Lock，在执行期间支持并发DML操作。</p><h3 id=instant>INSTANT<a hidden class=anchor aria-hidden=true href=#instant>#</a></h3><p>MySQL 5.8开始推出的方式，DDL只修改数据字典中的元数据，表数据不受影响，没有Exclusive Metadata Lock，允许并发的DML操作，支持的DDL变更是有限制的，目前主要包括添加字段，添加/删除生成列，修改ENUM或SET列，改变索引类型以及重命名表。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271581-2ea887cc-e4f2-4b44-934a-99b6c525094d.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271581-2ea887cc-e4f2-4b44-934a-99b6c525094d.webp alt></a></div><strong>比对下这三种方式的执行效率</strong></p><table><thead><tr><th>执行方式/项目</th><th>数据量(w)</th><th>执行时间(s)</th><th>重建表</th><th>修改MetaData</th><th>修改Data</th><th>允许并发DML</th></tr></thead><tbody><tr><td>COPY</td><td>650</td><td>29.89</td><td>YES</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>INPLACE</td><td>650</td><td>10.56</td><td>YES</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>INSTANT</td><td>650</td><td>0.19</td><td>No</td><td>Yes</td><td>No</td><td>Yes</td></tr></tbody></table><h3 id=online-ddl>ONLINE DDL<a hidden class=anchor aria-hidden=true href=#online-ddl>#</a></h3><p>截止MySQL 8.0，OnLine DDL有三种方式COPY，INPLACE，INSTANT，MySQL会自动根据执行的DDL选择使用哪种方式，一般会优先选择INSTANT方式，如果不支持，就选择INPLANCE方式，再不支持就只能选择COPY方式了。MySQL官方文档也给出了Online DDL的支持矩阵，列下常用的DDL操作，对比项主要包括是否重建表，允许并发的DML操作以及只修改元数据，表数据不受影响。</p><table><thead><tr><th>Operation</th><th>Instant</th><th>In Place</th><th>Copy</th><th>Rebuilds Table</th><th>Permits Concurrent DML</th><th>Only Modifies Metadata</th></tr></thead><tbody><tr><td>Adding a column</td><td>Yes</td><td>Yes*</td><td>Yes</td><td>No*</td><td>Yes*</td><td>Yes</td></tr><tr><td>Dropping a column</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td></tr><tr><td>Renaming a column</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Setting a column default value</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Dropping the column default value</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Changing the auto-increment value</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Making a column NULL</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes*</td><td>Yes</td><td>No</td></tr><tr><td>Making a column NOT NULL</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes*</td><td>Yes</td><td>No</td></tr><tr><td>Adding a primary key</td><td>No</td><td>Yes*</td><td>Yes</td><td>Yes*</td><td>Yes</td><td>No</td></tr><tr><td>Dropping a primary key</td><td>No</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>Creating or adding a secondary index</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>No</td></tr><tr><td>Dropping an index</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Renaming an index</td><td>No</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td><td>No</td></tr><tr><td>Adding a FULLTEXT index</td><td>No</td><td>Yes*</td><td>Yes</td><td>No*</td><td>No</td><td>No</td></tr></tbody></table><h2 id=大表ddl方案>大表DDL方案<a hidden class=anchor aria-hidden=true href=#大表ddl方案>#</a></h2><p>在实际业务系统中，业务发展比较快，表的数据量比较大，业务层面又做了读写分离，同时会将MySQL数据实时同步到数据仓库（包括实时数仓和离线数仓），实际的数据库架构如下。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271571-09e26623-8d79-4891-b332-bbc8152bc65e.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271571-09e26623-8d79-4891-b332-bbc8152bc65e.webp alt></a></div>假设这是一个交易系统数据库，订单表booking有8000w数据，且接入到了实时和离线仓库，根据业务需要，在订单表booking添加一个字段，在MySQL 5.7之前添加字段属于高危操作，需要充分考虑对业务的影响，主要存在于两个方面：</p><ol><li><strong>在读写分离场景，主从同步延迟导致业务数据不一致</strong></li><li><strong>实时数仓ADB不允许源端MySQL表重命名，如果通过COPY方式或者pt-osc、gh-ost等工具都会rename表名，那么就需要从数仓删除该表，重新配置同步（全量 + 增量），会影响数仓业务</strong></li></ol><h3 id=online-ddl方式>ONLINE DDL方式<a hidden class=anchor aria-hidden=true href=#online-ddl方式>#</a></h3><p>对于MySQL 5.6到5.7的版本，可以使用OnLine DDL的方式变更，对于大表来说，执行时间会很长，好处是在Master上DML操作不受影响，但是会导致主从延时。假如Master上添加字段执行了20分钟，相应的Slave也要执行20分钟，在这期间Slave一直处于延迟状态，会造成业务数据不一致，比如用户在Master下单成功，由于Slave延迟查询不到订单信息，用户误以为网络原因没有下单成功，又下了一单，导致重复下单的情况。这种方式会导致主从延迟，但是不会影响实时数仓的业务，根据业务情况，只能选择在业务低峰期执行了。</p><h3 id=pt-osc工具>pt-osc工具<a hidden class=anchor aria-hidden=true href=#pt-osc工具>#</a></h3><p>为了解决DDL变更导致主从延时对业务的影响，会想到用大表变更利器pt-osc（pt-online-schema-change）或者gh-ost工具来做，这两个工具执行过程及原理大同小异，变更流程如下（不考虑外键，按照MySQL规范不允许使用外键）：<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271572-0e617ac6-2763-4228-af44-9fb63c4b9ffd.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271572-0e617ac6-2763-4228-af44-9fb63c4b9ffd.webp alt></a></div></p><ol><li>创建一个新的表，表结构为修改后的数据表，用于从源数据表向新表中导入数据。</li><li>在源表上创建触发器，用于记录从拷贝数据开始之后，对源数据表继续进行数据修改的操作记录下来，用于数据拷贝结束后，执行这些操作，保证数据不会丢失。</li><li>拷贝数据，从源数据表中拷贝数据到新表中。</li><li>修改外键相关的子表，根据修改后的数据，修改外键关联的子表。</li><li>rename源数据表为old表，把新表rename为源表名，并将old表删除。</li><li>删除触发器。</li></ol><p>执行pt-osc的时候也需要获取一个Exclusive Metadata Lock，如果在此期间表上有DML操作正在进行，pt-osc操作会一直处于暂挂PENDING状态，这个时候表上正常DML操作都会被阻塞，MySQL活动连接数瞬间暴涨，CPU使用率100%，依赖的该表的接口都会报错，所以要选择在业务低峰期执行，同时做好MetaData Lock锁的监控以便业务不受影响，来看一个例子：<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271895-ccd2b310-519b-479a-95f8-838295f0c03b.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271895-ccd2b310-519b-479a-95f8-838295f0c03b.webp alt></a></div>D=trade, t=booking：数据库trade，表名booking。&ndash;chunk-size=1000：每次拷贝的数据行数。&ndash;max-log = 1：确保从库延迟不超过1s，超过就停止拷贝数据。&ndash;check-interval=2：表示等待2s之后继续拷贝数据。&ndash;recursion-method=&ldquo;hosts&rdquo;：如果不是使用默认端口3306，那么使用hosts方式来查找从库更可靠。一般MySQL binlog格式都是ROW，pt-osc在拷贝数据的过程也会产生大量的binlog，也可能导致主从延时，需要控制好每次拷贝数据的大小和频率，在执行期间，也会降低DML的并发度。</p><h3 id=mysql-80变更方式>MySQL 8.0变更方式<a hidden class=anchor aria-hidden=true href=#mysql-80变更方式>#</a></h3><p>用过Oracle的都知道，DDL变更都是修改元数据，上亿的表在Oracle中DDL变更都是瞬间完成。令人激动的是，MySQL 8.0也推出了INSTANT方式，真正的只修改MetaData，不影响表数据，所以它的执行效率跟表大小几乎没有关系。建议新系统上线用MySQL的话尽量使用MySQL 8.0，老的数据库也可以升级到MySQL 8.0获取更好的性能。官方文档对INSTANT的解释：<strong>INSTANT:</strong> _Operations only modify metadata in the data dictionary. No exclusive metadata locks are taken on the table during preparation and execution, and table data is unaffected, making operations instantaneous. Concurrent DML is permitted. (Introduced in MySQL 8.0.12)_既要解决主从同步，又要解决rename数仓不同步的问题，目前只有INSTANT方式满足需求了。</p><h2 id=监控ddl执行进度>监控DDL执行进度<a hidden class=anchor aria-hidden=true href=#监控ddl执行进度>#</a></h2><p>在大表执行DDL变更的时候，非常关心它的执行进度，MySQL 5.7之前是没有好的工具去监控，基本只能坐等了。在MySQL 8.0可以通过开启performance_schema，打开events_stages_current事件进行监控。<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271902-80c36682-abf5-4914-a0fe-c73309ae0529.webp><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1645121271902-80c36682-abf5-4914-a0fe-c73309ae0529.webp alt></a></div></p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>DDL在业务系统版本迭代的过程是必不可少的，如何在不影响业务以及外围系统的情况下，实现DDL的平滑变更，是需要综合个系统特性考虑的，评估出重要性和优先级，同时也要掌握不同MySQL版本DDL执行方式，以便我们做更好的选择。例如上面提到了，目前我在大数据团队，我们的业务都做了读写分离，同时接入实时数仓，数仓不支持rename操作，这时就可以选择在业务低峰期使用ONLINE DDL的方式执行，对业务系统影响最小，同时不影响数仓。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luolin1024.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/>数据库/Mysql</a></li></ul><nav class=paginav><a class=prev href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-b+-%E6%A0%91%E6%9D%A5%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%AF%B9%E6%AF%94-b-%E6%A0%91%E5%AE%83%E7%9A%84%E4%BC%98%E7%82%B9%E5%92%8C%E7%BC%BA%E7%82%B9%E6%98%AF%E4%BB%80%E4%B9%88/><span class=title>« Prev</span><br><span>MySQL 为什么使用 B+ 树来作索引，对比 B 树它的优点和缺点是什么？</span></a>
<a class=next href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/><span class=title>Next »</span><br><span>MySql性能优化基本知识</span></a></nav><div class=related-posts><h2>相关文章</h2><ul><li>· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql-rc%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B%E7%9A%84%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90/>Mysql rc隔离级别下的死锁分析</a></li><li>· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-b+-%E6%A0%91%E6%9D%A5%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%AF%B9%E6%AF%94-b-%E6%A0%91%E5%AE%83%E7%9A%84%E4%BC%98%E7%82%B9%E5%92%8C%E7%BC%BA%E7%82%B9%E6%98%AF%E4%BB%80%E4%B9%88/>MySQL 为什么使用 B+ 树来作索引，对比 B 树它的优点和缺点是什么？</a></li><li>· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/>MySql性能优化基本知识</a></li><li>· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E6%AD%BB%E9%94%81%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B%E4%B8%8E%E5%88%86%E6%9E%90/>MySQL死锁日志查看与分析</a></li><li>· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/>MySQL索引数据结构分析</a></li></ul></div></footer><link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline.css><div id=waline></div><script type=module>
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
    const locale = {
        nick: '昵称',
        nickError: '请填写昵称',
        mail: '邮箱',
        mailError: '请填写正确的邮件地址',
        link: '网址',
        optional: '可选',
        placeholder: '仅填写昵称即可发表回复。\n填写邮箱可收到回复提醒。\n评论区支持 Markdown 语法及预览。\n',
        sofa: '来发评论吧~',
        submit: '提交',
        like: '喜欢',
        cancelLike: '取消喜欢',
        reply: '回复',
        cancelReply: '取消回复',
        comment: '评论',
        refresh: '刷新',
        more: '加载更多...',
        preview: '预览',
        emoji: '表情',
        uploadImage: '上传图片',
        seconds: '秒前',
        minutes: '分钟前',
        hours: '小时前',
        days: '天前',
        now: '刚刚',
        uploading: '正在上传',
        login: '管理',
        logout: '退出',
        admin: '博主',
        sticky: '置顶',
        word: '字',
        wordHint: '评论字数应在 $0 到 $1 字之间！\n当前字数：$2',
        anonymous: '匿名',
        level0: '潜水',
        level1: '冒泡',
        level2: '吐槽',
        level3: '活跃',
        level4: '话痨',
        level5: '传说',
        gif: '表情包',
        gifSearchPlaceholder: '搜索表情包',
        profile: '个人资料',
        approved: '通过',
        waiting: '待审核',
        spam: '垃圾',
        unsticky: '取消置顶',
        oldest: '按倒序',
        latest: '按正序',
        hottest: '按热度',
        reactionTitle: '你认为这篇文章怎么样？',
    };
    init({
        
        el: '#waline',
        serverURL: 'https://blogcomments.luolin.online',
        locale,
        emoji: false,     
        search: false,    
        reaction: false,  
        requiredMeta: ['nick'],
        pageSize: 10,
        imageUploader: false,
        copyright: true,
        pageview: true,
        like: false,
    });
</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://luolin1024.github.io>luolin1024</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div>本站总访问量 <span id=umami_value_site_pv></span> 次
本站总访客数 <span id=umami_value_site_uv></span> 人
当前在线访客 <span id=umami_value_active_uv></span> 人</div><a href="https://icp.gov.moe/?keyword=20248618" target=_blank>萌ICP备20248618号</a></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>