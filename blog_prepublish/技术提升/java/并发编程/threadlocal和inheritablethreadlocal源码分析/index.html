<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ | luolin1024</title><meta name=keywords content="Java/JavaåŸºç¡€,æºç åˆ†æ"><meta name=description content="ThreadLocalåˆ†æ ä»€ä¹ˆæ˜¯ThreadLocal ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThrea"><meta name=author content="luolin"><link rel=canonical href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/threadlocal%E5%92%8Cinheritablethreadlocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/><script defer src=https://blogcounter.luolin.us.kg/script.js data-website-id=c8850e2c-16aa-465e-aa6f-5392c9397317></script>
<script src=/js/umami-stats.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script>
<link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://luolin1024.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://luolin1024.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luolin1024.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://luolin1024.github.io/apple-touch-icon.png><link rel=mask-icon href=https://luolin1024.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><html><head><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css><style>body{font-family:lxgw wenkai lite,sans-serif;font-family:lxgw wenkai screen,sans-serif}</style></head></html><meta property="og:title" content="ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ"><meta property="og:description" content="ThreadLocalåˆ†æ ä»€ä¹ˆæ˜¯ThreadLocal ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThrea"><meta property="og:type" content="article"><meta property="og:url" content="https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/threadlocal%E5%92%8Cinheritablethreadlocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="article:section" content="blog_prepublish"><meta property="article:published_time" content="2024-02-21T11:30:51+08:00"><meta property="article:modified_time" content="2024-03-21T00:55:26+08:00"><meta property="og:site_name" content="luolinçš„åšå®¢"><meta name=twitter:card content="summary"><meta name=twitter:title content="ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ"><meta name=twitter:description content="ThreadLocalåˆ†æ ä»€ä¹ˆæ˜¯ThreadLocal ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThrea"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog_prepublishes","item":"https://luolin1024.github.io/blog_prepublish/"},{"@type":"ListItem","position":2,"name":"ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ","item":"https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/threadlocal%E5%92%8Cinheritablethreadlocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ","name":"ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ","description":"ThreadLocalåˆ†æ ä»€ä¹ˆæ˜¯ThreadLocal ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThrea","keywords":["Java/JavaåŸºç¡€","æºç åˆ†æ"],"articleBody":"ThreadLocalåˆ†æ ä»€ä¹ˆæ˜¯ThreadLocal ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThreadLocalæ˜¯ä¸€ç§â€œçº¿ç¨‹å˜é‡â€ï¼Œåœ¨jdkä¸­ä¸€å¼€å§‹è®¾è®¡æ˜¯ç”¨æ¥å­˜å‚¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ï¼Œä½œç”¨åŸŸä¸çº¿ç¨‹ç»‘å®šã€‚é€šå¸¸ä½¿ç”¨private å’Œ staticä¿®é¥° ThreadLocalå˜é‡ï¼Œæ­¤æ—¶è¡¨ç¤ºä½œç”¨åŸŸä¸ºæœ¬ç±»ä¸­çš„çº¿ç¨‹ä½¿ç”¨åˆ°çš„æ–¹æ³•ã€‚å½“çº¿ç¨‹è¢«é”€æ¯ï¼Œå¯¹åº”çš„çº¿ç¨‹å˜é‡ä¹Ÿä¼šè¢«æ¸…é™¤ï¼ˆä¸ªäººæ˜¯è¿™æ ·ç†è§£çš„ï¼Œå› ä¸ºä½¿ç”¨Entryå­˜å‚¨å¯¹åº”çš„valueæ˜¯è™šå¼•ç”¨ï¼Œå½“å¯¹åº”çš„çº¿ç¨‹è¢«é”€æ¯æ—¶ï¼Œçº¿ç¨‹ï¼‰ã€‚ä½†æ˜¯åœ¨å½“å‰å¤§å¤šæ•°ä½¿ç”¨çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹çš„åœºæ™¯ä¸­ï¼Œçº¿ç¨‹æ˜¯ä¸ä¼šè¢«é”€æ¯çš„ï¼Œè¿™ä¹Ÿå°±ä»£è¡¨ç€ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ‰‹åŠ¨æ¸…é™¤çº¿ç¨‹å˜é‡ï¼Œ å¦åˆ™å°†ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚\nThreadLocalå˜é‡é€šå¸¸è¢«staticä¿®é¥°ï¼Œå¥½å¤„æ˜¯å®ƒå¯ä»¥é¿å…é‡å¤åˆ›å»ºTSO(Thread Specific Objectï¼Œå³ThreadLocalæ‰€å…³è”çš„å¯¹è±¡)æ‰€å¯¼è‡´çš„æµªè´¹ã€‚åå¤„æ˜¯è¿™æ ·åšå¯èƒ½æ­£å¥½å½¢æˆå†…å­˜æ³„æ¼æ‰€éœ€çš„æ¡ä»¶ã€‚\nåœ¨å¤§å¤šæ•°ç²¾å¯†çš„å¤šçº¿ç¨‹ä»£ç ä¸­éƒ½æœ‰ThreadLocalçš„å½±å­ï¼Œç†è§£ThreadLocalèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£javaå¤šçº¿ç¨‹ã€‚\nThreadLocalä½¿ç”¨ç¤ºä¾‹ public class ThreadlocalTest { private ThreadLocal\u003cString\u003e threadLocal = new ThreadLocal\u003c\u003e(); public void test() throws InterruptedException { threadLocal.set(\"parent\"); Thread thread = new Thread(() -\u003e { System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); threadLocal.set(\"child\"); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); }); thread.start(); thread.join(); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); } public static void main(String[] args) throws InterruptedException { new ThreadlocalTest().test(); } } è¾“å‡ºç»“æœï¼š\nThread-0 ===\u003e null Thread-0 ===\u003e child main ===\u003e parent é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ThreadLocalåœ¨æ¯ä¸ªçº¿ç¨‹ä¹‹é—´ç‹¬ç«‹çš„ï¼Œçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„ThreadLocalä¸å­çº¿ç¨‹çš„ThreadLocalä¹‹é—´æ²¡æœ‰å…³ç³»ï¼ŒçœŸæ­£çš„æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„å±æ€§ã€‚\næºç åˆ†æ é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ¸…æ¥šï¼ŒThreadã€ThreadLocalã€ThreadLocalMapè¿˜æœ‰ThreadLocalMap.Entryçš„å…³ç³»ï¼›å®ƒä»¬çš„å…³ç³»å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªThreadLocal.ThreadLocalMapå±æ€§çš„å˜é‡ï¼Œè€Œè¿™ä¸ªThreadLocalMapå˜é‡ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±»Entryï¼ŒEntryä¸­å­˜å‚¨çš„é”®å€¼å¯¹ï¼Œå…¶ä¸­referentæ˜¯çº¿ç¨‹å˜é‡çš„å¼•ç”¨ï¼Œvalueåˆ™æ˜¯æˆ‘ä»¬é€šè¿‡ThreadLocal.set()è®¾ç½®çš„å†…å®¹ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼ŒThreadã€ThreadLocalã€ThreadLocalMapè¿˜æœ‰ThreadLocalMap.Entryä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Threadä¸­å­˜å‚¨ThreadLocal.ThreadLocalMapå±æ€§çš„æœ‰ä¸¤ä¸ªå˜é‡ï¼šthreadLocalsã€inheritableThreadLocalsï¼›threadLocalsä¸å¯ä»¥åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä½¿ç”¨ï¼Œè€ŒinheritableThreadLocalså¯ä»¥åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä½¿ç”¨ã€‚\npublic class Thread implements Runnable { /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; } ThreadLocal.set()æ–¹æ³•ä»¥åŠsetç›¸å…³æ“ä½œï¼š\npublic class ThreadLocal\u003cT\u003e{ private final int threadLocalHashCode = nextHashCode(); public void set(T value) { // è·å–å½“å‰è°ƒç”¨è€…çº¿ç¨‹ Thread t = Thread.currentThread(); // å°è¯•æ ¹æ®è°ƒç”¨è€…çº¿ç¨‹è·å–è¯¥çº¿ç¨‹çš„ThreadLocalMap ThreadLocalMap map = getMap(t); if (map != null) // å‘ThreadLocalMapæ’å…¥é”®å€¼å¯¹ map.set(this, value); else // åœ¨ç¬¬ä¸€æ¬¡set()çš„æ—¶å€™åˆ›å»ºè¯¥çº¿ç¨‹çš„ThreadLocalMap createMap(t, value); } // åœ¨ç¬¬ä¸€æ¬¡set()æˆ–get()çš„æ—¶å€™åˆ›å»ºè¯¥çº¿ç¨‹çš„ThreadLocalMap void createMap(Thread t, T firstValue) { t.threadLocals = new ThreadLocalMap(this, firstValue); } static class ThreadLocalMap{ /** * å­˜å‚¨Entryçš„ */ private Entry[] table; // ThreadLocalMap ä¸­ç”¨æ¥å­˜å‚¨é”®å€¼å¯¹ static class Entry extends WeakReference\u003cThreadLocal\u003c?\u003e\u003e { /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal\u003c?\u003e k, Object v) { super(k); value = v; } } // åˆå§‹åŒ–ThreadLocalMap ThreadLocalMap(ThreadLocal\u003c?\u003e firstKey, Object firstValue) { // åˆå§‹Entryå¤§å°ä¸º16 table = new Entry[INITIAL_CAPACITY]; // åœ°å€ä¸‹æ ‡ = ç¬¬ä¸€ä¸ªï¼ˆå½“å‰ï¼‰ThreadLocalå˜é‡çš„hashå€¼\u002615ï¼Œè·å–ä¸€ä¸ªå¿…ç„¶å°äº15çš„å€¼ä½œä¸ºä¸‹æ ‡å­˜å‚¨value int i = firstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); size = 1; // è®¾ç½®æ‰©å®¹é˜€å€¼ = Entryå¤§å°(INITIAL_CAPACITY) * 2/3; åç»­æ‰©å®¹å¤§å° = å½“å‰å¤§å°*2ï¼Œæ‰©å®¹é˜€å€¼=Entryå¤§å°* 2/3; setThreshold(INITIAL_CAPACITY); } // å‘Entryä¸­æ’å…¥é”®å€¼å¯¹ private void set(ThreadLocal\u003c?\u003e key, Object value) { // We don't use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; // è®¡ç®—æ ‡ int i = key.threadLocalHashCode \u0026 (len-1); // ä½¿ç”¨ å¼€æ”¾å¯»å€æ³• è§£å†³hashå†²çª for (Entry e = tab[i]; e != null; // nextIndex(i,len) = ((i + 1 \u003c len) ? i + 1 : 0) e = tab[i = nextIndex(i, len)]) { // è·å–eçš„ThreadLocalå¼•ç”¨ ThreadLocal\u003c?\u003e k = e.get(); // eçš„ThreadLocalå¼•ç”¨ == å½“å‰è°ƒç”¨è€…çº¿ç¨‹ï¼Œåˆ™å°†valueè¦†ç›–åŸæœ‰value if (k == key) { e.value = value; return; } // eçš„ThreadLocalå¼•ç”¨ä¸ºç©ºï¼Œè€Œeä¸ä¸ºç©ºï¼Œè¯´æ˜å½“å‰çš„ThreadLocalå¼•ç”¨å·²ç»ä¸å¯è¾¾ï¼Œ // å°†éœ€è¦setçš„valueå’Œå¯¹åº”çš„ThreadLocalå¼•ç”¨è®¾ç½®åˆ°å½“å‰çš„Entryä¸­ // è¯¥æ“ä½œéœ€è¦å…ˆè§£å†³ThreadLocalå¼•ç”¨å¤±æ•ˆå¯¼è‡´çš„hashå€¼è®¡ç®—ä¸è¿ç»­é—®é¢˜ï¼Œå…³äºè¿™ä¸€ç‚¹å¯ä»¥äº†è§£ä¸€ä¸‹hashè¡¨å¼€æ”¾å¯»å€æ³•æŸ¥æ‰¾å…ƒç´  if (k == null) { replaceStaleEntry(key, value, i); return; } } // æ–°å¢ç»“ç‚¹åˆ°Entry tab[i] = new Entry(key, value); int sz = ++size; // å°è¯•æ¸…é™¤åç»­hash tableä¸­çš„ç»“ç‚¹ if (!cleanSomeSlots(i, sz) \u0026\u0026 sz \u003e= threshold) rehash(); } } } ThreadLocal.get()æ–¹æ³•ä»¥åŠgetç›¸å…³æ“ä½œï¼š\npublic class ThreadLocal\u003cT\u003e { // è·å–å½“å‰çº¿ç¨‹å˜é‡å¯¹åº”çš„value public T get() { // è·å–å½“å‰è°ƒç”¨è€…çº¿ç¨‹ Thread t = Thread.currentThread(); // è·å–çº¿ç¨‹ä¸­çš„ThreadLocalMap ThreadLocalMap map = getMap(t); if (map != null) { // è·å–ThreadLocalMapä¸­çš„Entry ThreadLocalMap.Entry e = map.getEntry(this); // Enrtyä¸ä¸ºç©ºæ—¶å°è¯•è·å–å¯¹åº”çš„valueï¼› // ä¸ºç©ºåˆ™è¡¨ç¤ºåœ¨è¿™ä¹‹å‰è¿›è¡Œè¿‡get()æ“ä½œåˆ›å»ºäº†ThreadLocalMap if (e != null) { @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; } } // è¿”å›é»˜è®¤å€¼ï¼Œé»˜è®¤è¿”å›null,å¯ä»¥é€šè¿‡å­ç±»é‡å†™è¯¥æ–¹æ³•ä¿®æ”¹é»˜è®¤è¿”å›å€¼ return setInitialValue(); } // è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap ThreadLocalMap getMap(Thread t) { // è¿”å›Threadä¸­çš„ThreadLocalMap return t.threadLocals; } /** * ThreadLocalä¸­ç”¨æ¥å­˜å‚¨\u003cå½“å‰çº¿ç¨‹,å­˜å‚¨çš„å€¼\u003eé”®å€¼å¯¹ */ static class ThreadLocalMap { // hashè¡¨ private Entry[] table; // è¿”å›ThreadLocalMapä¸­çš„hashè¡¨ private Entry getEntry(ThreadLocal\u003c?\u003e key) { // è®¡ç®— hashKey int i = key.threadLocalHashCode \u0026 (table.length - 1); // ä»hashTable Entry[]ä¸­è·å–å¯¹åº”çš„ThreadLocalå¼•ç”¨ Entry e = table[i]; if (e != null \u0026\u0026 e.get() == key) // Entryå‘½ä¸­çš„æ¡ä»¶æ˜¯eå­˜åœ¨ä¸Entry \u0026\u0026 eçš„å¼•ç”¨å’Œkeyç›¸åŒ return e; else // Entryæœªå‘½ä¸­ï¼ˆeä¸å­˜åœ¨||å­˜åœ¨hashå†²çªå¯¼è‡´eçš„å¼•ç”¨å’Œkeyä¸åŒï¼‰ï¼Œå‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entryæˆ–è€…è¿”å›æœ€åä¸€ä¸ªnullç»“ç‚¹ return getEntryAfterMiss(key, i, e); } // ç”±äºhashå†²çªå¯¼è‡´çš„æœªå‘½ä¸­ï¼Œå‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entryï¼Œæˆ–è€… private Entry getEntryAfterMiss(ThreadLocal\u003c?\u003e key, int i, Entry e) { Entry[] tab = table; int len = tab.length; // eä¸ºç©ºå°±ç›´æ¥è¿”å›null // eä¸ä¸ºç©ºåˆ™å‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entry while (e != null) { ThreadLocal\u003c?\u003e k = e.get(); if (k == key) // hashå‘½ä¸­ï¼Œè¿”å›e return e; if (k == null) // æ‰¾åˆ°æœ€åä¸€ä¸ªå¯ä»¥å­˜æ”¾ expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; } return null; } } /** * è¿˜æ²¡æœ‰é€šè¿‡setåˆ›å»ºThreadLocalMapæ—¶ï¼Œä½¿ç”¨getæ–¹æ³•ï¼Œé»˜è®¤åˆ›å»ºä¸€ä¸ªThreadLocalMap * @return the initial value */ private T setInitialValue() { // ThreadLocalç±»é»˜è®¤è¿”å›null T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else // åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadLocalMap createMap(t, value); return value; } /** * ThreadLocalä¸­valueé»˜è®¤å€¼ï¼Œå¯ä»¥é€šè¿‡å­ç±»é‡å†™è¯¥æ–¹æ³•ä¿®æ”¹get()é»˜è®¤è¿”å›çš„å€¼ * @return the initial value for this thread-local */ protected T initialValue() { return null; } } ThreadLocal.remove()æ–¹æ³•ä»¥åŠgetç›¸å…³æ“ä½œï¼š\npublic class ThreadLocal\u003cT\u003e { public void remove() { ThreadLocalMap m = getMap(Thread.currentThread()); if (m != null) m.remove(this); } static class ThreadLocalMap { private void remove(ThreadLocal\u003c?\u003e key) { Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode \u0026 (len-1); for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) { if (e.get() == key) { e.clear(); expungeStaleEntry(i); return; } } } private int expungeStaleEntry(int staleSlot) { Entry[] tab = table; int len = tab.length; // æ¸…é™¤Entryä¸­staleSlotä¸‹æ ‡çš„å€¼ tab[staleSlot].value = null; tab[staleSlot] = null; size--; // æ•´ç†hashTableï¼ˆEntryï¼‰ Entry e; int i; for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) { ThreadLocal\u003c?\u003e k = e.get(); if (k == null) { e.value = null; tab[i] = null; size--; } else { int h = k.threadLocalHashCode \u0026 (len - 1); if (h != i) { tab[i] = null; // Unlike Knuth 6.4 Algorithm R, we must scan until // null because multiple entries could have been stale. while (tab[h] != null) h = nextIndex(h, len); tab[h] = e; } } } return i; } } } ThreadLocalæ€»ç»“ å¯¹äºä¸€ä¸ªThreadæ¥è¯´ï¼ŒThreadLocalåªæ˜¯å…¶ä¸€ä¸ªå±æ€§å˜é‡ï¼Œå…¶ä¸­ä½¿ç”¨ThreadLocalMapå­˜æ”¾äº†è¯¥çº¿ç¨‹æ‰€å­˜æ”¾çš„æ‰€æœ‰çº¿ç¨‹å˜é‡ï¼Œä¸»è¦ä»¥å½¢å¼å­˜å‚¨ã€‚ Threadä¸ThreadLocalæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´Threadä¸ThreadLocalMapæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ ThreadLocalä¸ºä»€ä¹ˆè¦ä½¿ç”¨ThreadLocalMap? å› ä¸ºä¸€ä¸ªThreadä¸­å¯èƒ½å­˜æ”¾å¤šä¸ªçº¿ç¨‹å˜é‡ï¼Œå­˜åœ¨ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œæ‰€ä»¥ä¸€ä¸ªThreadè¦èƒ½å¤Ÿå¯¹åº”å¤šä¸ªçº¿ç¨‹å˜é‡ï¼Œçº¿ç¨‹å˜é‡è¿˜éœ€è¦ä¸è‡ªå·±çš„valueä¸€å¯¹ä¸€å¯¹åº”ã€‚ å“ˆå¸Œå†²çªå­˜åœ¨ä¸¤ç§è§£å†³æ–¹æ³•ï¼šå¼€æ”¾å¯»å€æ³•å’Œé“¾è¡¨æ³•ã€‚ThreadLocalMapä¸­çš„Entryä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼€æ”¾å¯»å€æ³•ï¼Ÿä½¿ç”¨å¼€æ”¾å¯»å€æ³•è§£å†³å†²çªçš„æ•£ï¦œè¡¨ï¼Œè£…è½½å› å­çš„ä¸Šé™ï¥§èƒ½å¤ªå¤§ã€‚è¿™ä¹Ÿå¯¼è‡´è¿™ç§æ–¹æ³•æ¯”é“¾è¡¨æ³•ï¤æµªè´¹å†…å­˜ç©ºé—´ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œé“¾è¡¨æ³•éœ€è¦é¢å¤–çš„ç©ºé—´ï¼Œå½“ç»“ç‚¹è§„æ¨¡è¾ƒå°æ—¶ï¼Œå¼€æ”¾å¯»å€æ³•è¾ƒä¸ºèŠ‚çœç©ºé—´ã€‚å¯¹äºThreadLocalçº¿ç¨‹å˜é‡æ¥è®²ï¼Œå°†èŠ‚çœçš„æŒ‡é’ˆç©ºé—´ç”¨æ¥æ‰©å¤§æ•£åˆ—è¡¨çš„è§„æ¨¡ï¼Œå¯ä½¿è£…å¡«å› å­å˜å°ï¼Œè¿™åˆå‡å°‘äº†å¼€æ”¾å¯»å€æ³•ä¸­çš„å†²çªï¼Œä»è€Œæé«˜å¹³å‡æŸ¥æ‰¾é€Ÿåº¦ã€‚ å¯¹äºThreadLocalä¸­çš„ThreadLocalMapã€ThreadLocalMap.Entryæœ‰ç–‘é—®ï¼Œçœ‹çœ‹hashTableçš„åŸç†ï¼Œå¯ä»¥å¾ˆå¥½çš„å¸®åŠ©ç†è§£ThreadLocalã€‚ ä¸‹å›¾å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©ç†è§£ThreadLocalå˜é‡ã€ThreadLocal.ThreadLocalMapä»¥åŠEntryä¹‹é—´çš„å…³ç³»ã€‚ InheritableThreadLocalåˆ†æ InheritableThreadLocalä½¿ç”¨èƒŒæ™¯ å…¶å®ä¸Šè¿°è®²è§£ThreadLocalçš„æ—¶å€™ï¼Œä½¿ç”¨åˆ°çš„ç¤ºä¾‹ä¸­å±•ç¤ºäº†ThreadLocalæ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ThreadLocalå˜é‡ã€‚ä½†æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬æ˜¯éœ€è¦å°†çˆ¶çº¿ç¨‹ä¸­çš„æŸäº›çº¿ç¨‹å˜é‡ä¼ é€’ç»™å­çº¿ç¨‹çš„ï¼Œæ¯”å¦‚çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡å­˜å‚¨ç€ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤æ—¶çˆ¶çº¿ç¨‹å¼€å¯äº†å¤šä¸ªå­çº¿ç¨‹ï¼Œå­çº¿ç¨‹éœ€è¦æŠŠç”¨æˆ·ä¿¡æ¯ä»¥åŠä¸€äº›ä¸šåŠ¡ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦æŠŠç”¨æˆ·çš„ä¿¡æ¯ä¼ é€’ç»™å­çº¿ç¨‹çš„ï¼›å¯¹äºè¿™ç§åœºæ™¯æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œæ–¹æ¡ˆä¸€å°±æ˜¯æŠŠç”¨æˆ·ä¿¡æ¯æå–ä¸ºä¸€ä¸ªæ™®é€šå±€éƒ¨å˜é‡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™å­çº¿ç¨‹çš„æ–¹æ³•ä¸­ï¼›æ–¹æ¡ˆäºŒåˆ™æ˜¯å°†ç”¨æˆ·ä¿¡æ¯ç›´æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œä½†æ˜¯å•çº¯å‡­å€ŸThreadLocalæ— æ³•å®ç°å˜é‡ä¼ é€’ï¼Œæ­¤æ—¶InheritableThreadLocalå°±å¯ä»¥å¼€å§‹å‘æŒ¥ä½œç”¨äº†ã€‚\nInheritableThreadLocalä½¿ç”¨å®ä¾‹ public class ThreadlocalTest { private ThreadLocal\u003cString\u003e threadLocal = new InheritableThreadLocal\u003c\u003e(); public void test() throws InterruptedException { threadLocal.set(\"parent\"); Thread thread = new Thread(() -\u003e { System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); threadLocal.set(\"child\"); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); }); thread.start(); thread.join(); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get()); } public static void main(String[] args) throws InterruptedException { new ThreadlocalTest().test(); } } è¾“å‡ºç»“æœ\nThread-0 ===\u003e parent Thread-0 ===\u003e child main ===\u003e parent æºç åˆ†æ å…ˆçœ‹ä¸‹InheritableThreadLocalç±»ï¼Œä»¥åŠå®ƒæ‰€é‡å†™ThreadLocalçš„setMapå’ŒgetMapæ–¹æ³•ï¼š\npublic class InheritableThreadLocal\u003cT\u003e extends ThreadLocal\u003cT\u003e { /** * åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™æµ…æ‹·è´è¿”å›çˆ¶çº¿ç¨‹æŒæœ‰çš„InheritableThreadLocal.ThreadLocalMap.Entry.valueçš„å¼•ç”¨ * å¦‚æœæƒ³è¦æ·±æ‹·è´valueï¼Œåˆ™éœ€è¦å­ç±»é‡å†™è¯¥æ–¹æ³• * * @param parentValue the parent thread's value * @return the child thread's initial value */ protected T childValue(T parentValue) { return parentValue; } /** * è¿”å›çº¿ç¨‹tçš„inheritableThreadLocalså˜é‡ * ä½¿ç”¨æ—¶åˆ©ç”¨å‘ä¸‹è½¬å‹è·å–InheritableThreadLocalå˜é‡ï¼Œæ‰€ä»¥InheritableThreadLocal.get()åªä¼šè·å–å¯¹åº”çº¿ç¨‹çš„inheritableThreadLocalså˜é‡ * * @param t the current thread */ ThreadLocalMap getMap(Thread t) { return t.inheritableThreadLocals; } /** * è®¾ç½®çº¿ç¨‹tçš„inheritableThreadLocalså˜é‡ * ä½¿ç”¨æ—¶åˆ©ç”¨å‘ä¸‹è½¬å‹è®¾ç½®InheritableThreadLocalå˜é‡ï¼Œæ‰€ä»¥InheritableThreadLocal.set()åªä¼šè®¾ç½®å¯¹åº”çº¿ç¨‹çš„inheritableThreadLocalså˜é‡ * @param t the current thread * @param firstValue value for the initial entry of the table. */ void createMap(Thread t, T firstValue) { t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue); } } é‚£å­çº¿ç¨‹åˆæ˜¯å¦‚ä½•è·å–åˆ°çˆ¶çº¿ç¨‹çš„ThreadLocalå˜é‡å‘¢ï¼ŒæŸ¥çœ‹Threadç±»ä¸­æ–°å»ºä¸€ä¸ªçº¿ç¨‹æºç ï¼š\npublic class Thread implements Runnable { /* * InheritableThreadLocal values pertaining to this thread. This map is * maintained by the InheritableThreadLocal class. */ ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; public Thread(Runnable target) { init(null, target, \"Thread-\" + nextThreadNum(), 0); } private void init(ThreadGroup g, Runnable target, String name, long stackSize) { init(g, target, name, stackSize, null, true); } /** * Initializes a Thread. åˆå§‹åŒ–çº¿ç¨‹ * * @param g the Thread group * @param target the object whose run() method gets called * @param name the name of the new Thread * @param stackSize the desired stack size for the new thread, or * zero to indicate that this parameter is to be ignored. * @param acc the AccessControlContext to inherit, or * AccessController.getContext() if null * @param inheritThreadLocals if {@code true}, inherit initial values for * inheritable thread-locals from the constructing thread æ˜¯å¦ä»è°ƒç”¨æ–¹ç»§æ‰¿InheritableThreadLocalå˜é‡ */ private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) { if (name == null) { throw new NullPointerException(\"name cannot be null\"); } this.name = name; // å½“å‰è°ƒç”¨è€…çº¿ç¨‹ä¸ºçˆ¶çº¿ç¨‹ Thread parent = currentThread(); SecurityManager security = System.getSecurityManager(); if (g == null) { /* Determine if it's an applet or not */ /* If there is a security manager, ask the security manager what to do. */ if (security != null) { g = security.getThreadGroup(); } /* If the security doesn't have a strong opinion of the matter use the parent thread group. */ if (g == null) { g = parent.getThreadGroup(); } } /* checkAccess regardless of whether or not threadgroup is explicitly passed in. */ g.checkAccess(); /* * Do we have the required permissions? */ if (security != null) { if (isCCLOverridden(getClass())) { security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION); } } g.addUnstarted(); this.group = g; this.daemon = parent.isDaemon(); this.priority = parent.getPriority(); if (security == null || isCCLOverridden(parent.getClass())) this.contextClassLoader = parent.getContextClassLoader(); else this.contextClassLoader = parent.contextClassLoader; this.inheritedAccessControlContext = acc != null ? acc : AccessController.getContext(); this.target = target; setPriority(priority); // å¦‚æœinheritThreadLocals == trueï¼ˆé»˜è®¤new Threadéƒ½æ˜¯trueï¼‰å¹¶ä¸”çˆ¶çº¿ç¨‹å­˜åœ¨InheritableThreadLocalå˜é‡ï¼Œ // å½“å‰çº¿ç¨‹å°†ä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„InheritableThreadLocalåˆ°æœ¬çº¿ç¨‹ä¸­ if (inheritThreadLocals \u0026\u0026 parent.inheritableThreadLocals != null) this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); /* Stash the specified stack size in case the VM cares */ this.stackSize = stackSize; /* Set thread ID */ tid = nextThreadID(); } } public class ThreadLocal\u003cT\u003e { // å­çº¿ç¨‹å¤åˆ¶çˆ¶çº¿ç¨‹çš„ThreadLocalå˜é‡ static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap) { return new ThreadLocalMap(parentMap); } static class ThreadLocalMap { // æ·±æ‹·è´ThreadLocalMap,æµ…æ‹·è´Entryä¸­çš„value private ThreadLocalMap(ThreadLocalMap parentMap) { Entry[] parentTable = parentMap.table; int len = parentTable.length; setThreshold(len); table = new Entry[len]; for (int j = 0; j \u003c len; j++) { Entry e = parentTable[j]; if (e != null) { @SuppressWarnings(\"unchecked\") ThreadLocal\u003cObject\u003e key = (ThreadLocal\u003cObject\u003e) e.get(); if (key != null) { // æ‹·è´çˆ¶çº¿ç¨‹æŒæœ‰çš„InheritableThreadLocal.ThreadLocalMap.Entry.value // InheritableThreadLocalé»˜è®¤ä½¿ç”¨æµ…æ‹·è´ï¼ˆç›´æ¥è¿”å›å¼•ç”¨ï¼‰ // å¦‚æœéœ€è¦æ·±æ‹·è´ï¼Œåˆ™éœ€è¦InheritableThreadLocalå­ç±»é‡å†™childValueæ–¹æ³• Object value = key.childValue(e.value); Entry c = new Entry(key, value); // è®¡ç®—ä¸‹ä¸€ä¸ªhashä¸‹æ ‡ int h = key.threadLocalHashCode \u0026 (len - 1); while (table[h] != null) h = nextIndex(h, len); table[h] = c; size++; } } } } } } InheritableThreadLocal æ‹·è´æœºåˆ¶ InheritableThreadLocalä¸ThreadLocalçš„åŒºåˆ«å°±åœ¨äºçˆ¶çº¿ç¨‹å¯ä»¥å°†InheritableThreadLocalå˜é‡æ·±æ‹·è´ä¸€ä»½åˆ°å­çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯Entryä¸­çš„vaueåˆ™æ˜¯æµ…æ‹·è´ï¼Œä¹Ÿå°±æ˜¯è¯´å‡å¦‚å­çº¿ç¨‹é€šè¿‡get()æ–¹æ³•è·å–åˆ°å¯¹åº”çš„valueä¹‹åï¼Œç›´æ¥ä¿®æ”¹valueçš„å€¼ï¼Œçˆ¶çº¿ç¨‹ä¸­è·å–åˆ°çš„valueçš„å€¼ä¹Ÿä¼šè¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹ï¼š\npublic class ThreadlocalTest { private ThreadLocal\u003cPerson\u003e threadLocal = new InheritableThreadLocal\u003c\u003e(); public void test() throws InterruptedException { threadLocal.set(new Person(\"a\", 13)); Thread thread = new Thread(() -\u003e { System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get().toString() + \"===\u003e\" +threadLocal.get().hashCode()); threadLocal.get().setAge(15); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get().toString() + \"===\u003e\" +threadLocal.get().hashCode()); }); thread.start(); thread.join(); System.out.println(Thread.currentThread().getName() + \" ===\u003e \" + threadLocal.get().toString() + \"===\u003e\" +threadLocal.get().hashCode()); threadLocal.remove(); System.out.println(); } public static void main(String[] args) throws InterruptedException { new ThreadlocalTest().test(); } } è¾“å‡ºç»“æœï¼š\nThread-0 ===\u003e Person{name='a', age=13}===\u003e2024651980 Thread-0 ===\u003e Person{name='a', age=15}===\u003e2024651980 main ===\u003e Person{name='a', age=15}===\u003e2024651980 åœ¨å­çº¿ç¨‹ä¸­ä¿®æ”¹äº†get()è·å–åˆ°çš„valueä¸­çš„å±æ€§å€¼ï¼Œçˆ¶çº¿ç¨‹é€šè¿‡get()è·å–åˆ°çš„valueä¹Ÿå‘ç”Ÿäº†æ”¹å˜ï¼Œä¸”çˆ¶å­çº¿ç¨‹ä¸­get()è·å–åˆ°çš„valueçš„åœ°å€æ˜¯ç›¸åŒçš„ã€‚\nInheritableThreadLocalæ€»ç»“ ç›¸æ¯”è¾ƒThreadLocalï¼ŒInheritableThreadLocalå®Œæˆäº†çˆ¶å­çº¿ç¨‹ä¹‹é—´çº¿ç¨‹å˜é‡çš„ä¼ é€’ï¼Œå®ç°æ–¹æ¡ˆæ˜¯çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™ï¼Œçˆ¶çº¿ç¨‹æœ¬èº«æ–°å»ºäº†ä¸€ä¸ªInheritableThreadLocalå˜é‡å­˜æ”¾inheritableThreadLocalsä¸­ï¼Œå­çº¿ç¨‹ä»çˆ¶çº¿ç¨‹æ‹·è´inheritableThreadLocalså±æ€§ï¼Œè€ŒInheritableThreadLocalç»§æ‰¿è‡ªThreadLocalï¼Œä½¿å¾—å…¶å®Œç¾æ‰¿è½½äº†ThreadLocalçš„å±æ€§ï¼Œåªæ˜¯é‡å†™å…¶ä¸­çš„setMapå’ŒgetMapæ–¹æ³•åä½¿å¾—å…¶è¿”å›çš„mapä¸ºçº¿ç¨‹çš„inheritableThreadLocalså˜é‡ã€‚ çˆ¶çº¿ç¨‹æ–°å»ºå­çº¿ç¨‹çš„æ—¶å€™ï¼ŒThreadLocalMapæ˜¯æ·±æ‹·è´ï¼Œä½†æ˜¯Entryä¸­çš„valueæ˜¯æµ…æ‹·è´ï¼Œä¹Ÿå°±æ„å‘³ç€å­çº¿ç¨‹é€šè¿‡get()è·å–åˆ°çš„valueä¿®æ”¹ä¹‹åï¼Œçˆ¶çº¿ç¨‹å†é€šè¿‡get()è·å–valueä¹Ÿæ˜¯ä¿®æ”¹è¿‡åçš„ã€‚ æ€è€ƒ ç›®å‰å·²ç»å¾ˆå°‘å‡ºç°é€šè¿‡è‡ªå·±æ‰‹åŠ¨new Threadå¯åŠ¨çº¿ç¨‹äº†ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ThreadPoolå®ç°ã€‚åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹æ± æ˜¯å¤ç”¨çº¿ç¨‹ï¼Œä¸ä¼šé‡å¤åˆ›å»ºï¼Œè€ŒInheritableThreadLocalæ˜¯åœ¨åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™æ‰ä¼šå°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶åˆ°å­çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯çº¿ç¨‹æ± ä¸ä¼šé‡å¤åˆ›å»ºï¼Œæ‰€ä»¥å¤šæ¬¡ä½¿ç”¨åï¼Œä»ç„¶è®°å½•çš„æ˜¯ç¬¬ä¸€æ¬¡æäº¤ä»»åŠ¡æ—¶çš„å¤–éƒ¨çº¿ç¨‹çš„å€¼ï¼Œä¼šé€ æˆæ•°æ®çš„é”™è¯¯ã€‚\n","wordCount":"6677","inLanguage":"en","datePublished":"2024-02-21T11:30:51+08:00","dateModified":"2024-03-21T00:55:26+08:00","author":{"@type":"Person","name":"luolin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/threadlocal%E5%92%8Cinheritablethreadlocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},"publisher":{"@type":"Organization","name":"luolin1024","logo":{"@type":"ImageObject","url":"https://luolin1024.github.io/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luolin1024.github.io accesskey=h title="luolinçš„åšå®¢ (Alt + H)">luolinçš„åšå®¢</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://luolin1024.github.io/posts title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://luolin1024.github.io/archives/ title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://luolin1024.github.io/search/ title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://luolin1024.github.io/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://luolin1024.github.io/about title=ğŸ™‹ğŸ»â€â™‚ï¸å…³äº><span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span></a></li><li><a href=https://luolin1024.github.io/links title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://luolin1024.github.io>Home</a>&nbsp;Â»&nbsp;<a href=https://luolin1024.github.io/blog_prepublish/>Blog_prepublishes</a></div><h1 class="post-title entry-hint-parent">ThreadLocalå’ŒInheritableThreadLocalæºç åˆ†æ</h1><div class=post-meta><span title='2024-02-21 11:30:51 +0800 +0800'>2024-02-21</span>&nbsp;Â·&nbsp;14 min&nbsp;Â·&nbsp;6677 words&nbsp;Â·&nbsp;luolin
æœ¬æ–‡æ€»é˜…è¯»é‡ <span id=umami_value_page_pv></span> æ¬¡
æœ¬æ–‡æ€»è®¿å®¢é‡ <span id=umami_value_page_uv></span> äºº</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#threadlocal%e5%88%86%e6%9e%90 aria-label=ThreadLocalåˆ†æ>ThreadLocalåˆ†æ</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afthreadlocal aria-label=ä»€ä¹ˆæ˜¯ThreadLocal>ä»€ä¹ˆæ˜¯ThreadLocal</a></li><li><a href=#threadlocal%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=ThreadLocalä½¿ç”¨ç¤ºä¾‹>ThreadLocalä½¿ç”¨ç¤ºä¾‹</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=æºç åˆ†æ>æºç åˆ†æ</a></li><li><a href=#threadlocal%e6%80%bb%e7%bb%93 aria-label=ThreadLocalæ€»ç»“>ThreadLocalæ€»ç»“</a></li></ul></li><li><a href=#inheritablethreadlocal%e5%88%86%e6%9e%90 aria-label=InheritableThreadLocalåˆ†æ>InheritableThreadLocalåˆ†æ</a><ul><li><a href=#inheritablethreadlocal%e4%bd%bf%e7%94%a8%e8%83%8c%e6%99%af aria-label=InheritableThreadLocalä½¿ç”¨èƒŒæ™¯>InheritableThreadLocalä½¿ç”¨èƒŒæ™¯</a></li><li><a href=#inheritablethreadlocal%e4%bd%bf%e7%94%a8%e5%ae%9e%e4%be%8b aria-label=InheritableThreadLocalä½¿ç”¨å®ä¾‹>InheritableThreadLocalä½¿ç”¨å®ä¾‹</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1 aria-label=æºç åˆ†æ>æºç åˆ†æ</a></li><li><a href=#inheritablethreadlocal-%e6%8b%b7%e8%b4%9d%e6%9c%ba%e5%88%b6 aria-label="InheritableThreadLocal æ‹·è´æœºåˆ¶">InheritableThreadLocal æ‹·è´æœºåˆ¶</a></li><li><a href=#inheritablethreadlocal%e6%80%bb%e7%bb%93 aria-label=InheritableThreadLocalæ€»ç»“>InheritableThreadLocalæ€»ç»“</a></li></ul></li><li><a href=#%e6%80%9d%e8%80%83 aria-label=æ€è€ƒ>æ€è€ƒ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h3 id=threadlocalåˆ†æ>ThreadLocalåˆ†æ<a hidden class=anchor aria-hidden=true href=#threadlocalåˆ†æ>#</a></h3><h4 id=ä»€ä¹ˆæ˜¯threadlocal>ä»€ä¹ˆæ˜¯ThreadLocal<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯threadlocal>#</a></h4><p>ThreadLocalæ˜¯ä¸€ç§å˜é‡ç±»å‹ï¼Œä¸æ™®é€šçš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡æ‰€ä¸åŒçš„æ˜¯ï¼ŒThreadLocalæ˜¯ä¸€ç§â€œçº¿ç¨‹å˜é‡â€ï¼Œåœ¨jdkä¸­ä¸€å¼€å§‹è®¾è®¡æ˜¯ç”¨æ¥å­˜å‚¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ï¼Œä½œç”¨åŸŸä¸çº¿ç¨‹ç»‘å®šã€‚é€šå¸¸ä½¿ç”¨private å’Œ staticä¿®é¥° ThreadLocalå˜é‡ï¼Œæ­¤æ—¶è¡¨ç¤ºä½œç”¨åŸŸä¸ºæœ¬ç±»ä¸­çš„çº¿ç¨‹ä½¿ç”¨åˆ°çš„æ–¹æ³•ã€‚å½“çº¿ç¨‹è¢«é”€æ¯ï¼Œå¯¹åº”çš„çº¿ç¨‹å˜é‡ä¹Ÿä¼šè¢«æ¸…é™¤ï¼ˆä¸ªäººæ˜¯è¿™æ ·ç†è§£çš„ï¼Œå› ä¸ºä½¿ç”¨Entryå­˜å‚¨å¯¹åº”çš„valueæ˜¯è™šå¼•ç”¨ï¼Œå½“å¯¹åº”çš„çº¿ç¨‹è¢«é”€æ¯æ—¶ï¼Œçº¿ç¨‹ï¼‰ã€‚ä½†æ˜¯åœ¨å½“å‰å¤§å¤šæ•°ä½¿ç”¨çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹çš„åœºæ™¯ä¸­ï¼Œçº¿ç¨‹æ˜¯ä¸ä¼šè¢«é”€æ¯çš„ï¼Œè¿™ä¹Ÿå°±ä»£è¡¨ç€ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ‰‹åŠ¨æ¸…é™¤çº¿ç¨‹å˜é‡ï¼Œ å¦åˆ™å°†ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</p><blockquote><p>ThreadLocalå˜é‡é€šå¸¸è¢«staticä¿®é¥°ï¼Œå¥½å¤„æ˜¯å®ƒå¯ä»¥é¿å…é‡å¤åˆ›å»ºTSO(Thread Specific Objectï¼Œå³ThreadLocalæ‰€å…³è”çš„å¯¹è±¡)æ‰€å¯¼è‡´çš„æµªè´¹ã€‚åå¤„æ˜¯è¿™æ ·åšå¯èƒ½æ­£å¥½å½¢æˆå†…å­˜æ³„æ¼æ‰€éœ€çš„æ¡ä»¶ã€‚</p></blockquote><p>åœ¨å¤§å¤šæ•°ç²¾å¯†çš„å¤šçº¿ç¨‹ä»£ç ä¸­éƒ½æœ‰ThreadLocalçš„å½±å­ï¼Œç†è§£ThreadLocalèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£javaå¤šçº¿ç¨‹ã€‚</p><h4 id=threadlocalä½¿ç”¨ç¤ºä¾‹>ThreadLocalä½¿ç”¨ç¤ºä¾‹<a hidden class=anchor aria-hidden=true href=#threadlocalä½¿ç”¨ç¤ºä¾‹>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadlocalTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>threadLocal</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;parent&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;child&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ThreadlocalTest</span><span class=o>().</span><span class=na>test</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>è¾“å‡ºç»“æœï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=n>child</span>
</span></span><span class=line><span class=cl><span class=n>main</span> <span class=o>===&gt;</span> <span class=n>parent</span>
</span></span></code></pre></div><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ThreadLocalåœ¨æ¯ä¸ªçº¿ç¨‹ä¹‹é—´ç‹¬ç«‹çš„ï¼Œçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„ThreadLocalä¸å­çº¿ç¨‹çš„ThreadLocalä¹‹é—´æ²¡æœ‰å…³ç³»ï¼ŒçœŸæ­£çš„æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„å±æ€§ã€‚</p><h4 id=æºç åˆ†æ>æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#æºç åˆ†æ>#</a></h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ¸…æ¥šï¼ŒThreadã€ThreadLocalã€ThreadLocalMapè¿˜æœ‰ThreadLocalMap.Entryçš„å…³ç³»ï¼›å®ƒä»¬çš„å…³ç³»å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªThreadLocal.ThreadLocalMapå±æ€§çš„å˜é‡ï¼Œè€Œè¿™ä¸ªThreadLocalMapå˜é‡ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±»Entryï¼ŒEntryä¸­å­˜å‚¨çš„&lt;referentï¼Œ value>é”®å€¼å¯¹ï¼Œå…¶ä¸­referentæ˜¯çº¿ç¨‹å˜é‡çš„å¼•ç”¨ï¼Œvalueåˆ™æ˜¯æˆ‘ä»¬é€šè¿‡ThreadLocal.set()è®¾ç½®çš„å†…å®¹ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼ŒThreadã€ThreadLocalã€ThreadLocalMapè¿˜æœ‰ThreadLocalMap.Entryä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601362147957-992b4249-a404-4246-b036-c0fed3f751b4.png><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601362147957-992b4249-a404-4246-b036-c0fed3f751b4.png alt="ThreadLocal (5).png"></a></div></p><p>Threadä¸­å­˜å‚¨ThreadLocal.ThreadLocalMapå±æ€§çš„æœ‰ä¸¤ä¸ªå˜é‡ï¼šthreadLocalsã€inheritableThreadLocalsï¼›threadLocalsä¸å¯ä»¥åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä½¿ç”¨ï¼Œè€ŒinheritableThreadLocalså¯ä»¥åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä½¿ç”¨ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Thread</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* ThreadLocal values pertaining to this thread. This map is maintained
</span></span></span><span class=line><span class=cl><span class=cm>     * by the ThreadLocal class. */</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>ThreadLocalMap</span> <span class=n>threadLocals</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ThreadLocal.set()æ–¹æ³•ä»¥åŠsetç›¸å…³æ“ä½œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>threadLocalHashCode</span> <span class=o>=</span> <span class=n>nextHashCode</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>T</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å–å½“å‰è°ƒç”¨è€…çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°è¯•æ ¹æ®è°ƒç”¨è€…çº¿ç¨‹è·å–è¯¥çº¿ç¨‹çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å‘ThreadLocalMapæ’å…¥&lt;ThreadLocal, value&gt;é”®å€¼å¯¹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>map</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åœ¨ç¬¬ä¸€æ¬¡set()çš„æ—¶å€™åˆ›å»ºè¯¥çº¿ç¨‹çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>createMap</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åœ¨ç¬¬ä¸€æ¬¡set()æˆ–get()çš„æ—¶å€™åˆ›å»ºè¯¥çº¿ç¨‹çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span> <span class=nf>createMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>,</span> <span class=n>T</span> <span class=n>firstValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=na>threadLocals</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocalMap</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>firstValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadLocalMap</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * å­˜å‚¨Entryçš„
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>Entry</span><span class=o>[]</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// ThreadLocalMap ä¸­ç”¨æ¥å­˜å‚¨&lt;ThreadLocalå¼•ç”¨å˜é‡,ThreadLocal æ‰€ä¿å­˜çš„å€¼&gt;é”®å€¼å¯¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/** The value associated with this ThreadLocal. */</span>
</span></span><span class=line><span class=cl>            <span class=n>Object</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span><span class=o>,</span> <span class=n>Object</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>super</span><span class=o>(</span><span class=n>k</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>value</span> <span class=o>=</span> <span class=n>v</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åˆå§‹åŒ–ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ThreadLocalMap</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>firstKey</span><span class=o>,</span> <span class=n>Object</span> <span class=n>firstValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åˆå§‹Entryå¤§å°ä¸º16
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>table</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>[</span><span class=n>INITIAL_CAPACITY</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åœ°å€ä¸‹æ ‡ = ç¬¬ä¸€ä¸ªï¼ˆå½“å‰ï¼‰ThreadLocalå˜é‡çš„hashå€¼&amp;15ï¼Œè·å–ä¸€ä¸ªå¿…ç„¶å°äº15çš„å€¼ä½œä¸ºä¸‹æ ‡å­˜å‚¨value
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>firstKey</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>INITIAL_CAPACITY</span> <span class=o>-</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>(</span><span class=n>firstKey</span><span class=o>,</span> <span class=n>firstValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è®¾ç½®æ‰©å®¹é˜€å€¼ = Entryå¤§å°(INITIAL_CAPACITY) * 2/3; åç»­æ‰©å®¹å¤§å° = å½“å‰å¤§å°*2ï¼Œæ‰©å®¹é˜€å€¼=Entryå¤§å°* 2/3;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>setThreshold</span><span class=o>(</span><span class=n>INITIAL_CAPACITY</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å‘Entryä¸­æ’å…¥&lt;ThreadLocal,value&gt;é”®å€¼å¯¹
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>,</span> <span class=n>Object</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// We don&#39;t use a fast path as with get() because it is at
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// least as common to use set() to create new entries as
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// it is to replace existing ones, in which case, a fast
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// path would fail more often than not.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è®¡ç®—æ ‡
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>len</span><span class=o>-</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// ä½¿ç”¨ å¼€æ”¾å¯»å€æ³• è§£å†³hashå†²çª
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                 <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                 <span class=c1>// nextIndex(i,len) = ((i + 1 &lt; len) ? i + 1 : 0)
</span></span></span><span class=line><span class=cl><span class=c1></span>                 <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>)])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// è·å–eçš„ThreadLocalå¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// eçš„ThreadLocalå¼•ç”¨ == å½“å‰è°ƒç”¨è€…çº¿ç¨‹ï¼Œåˆ™å°†valueè¦†ç›–åŸæœ‰value
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// eçš„ThreadLocalå¼•ç”¨ä¸ºç©ºï¼Œè€Œeä¸ä¸ºç©ºï¼Œè¯´æ˜å½“å‰çš„ThreadLocalå¼•ç”¨å·²ç»ä¸å¯è¾¾ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// å°†éœ€è¦setçš„valueå’Œå¯¹åº”çš„ThreadLocalå¼•ç”¨è®¾ç½®åˆ°å½“å‰çš„Entryä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// è¯¥æ“ä½œéœ€è¦å…ˆè§£å†³ThreadLocalå¼•ç”¨å¤±æ•ˆå¯¼è‡´çš„hashå€¼è®¡ç®—ä¸è¿ç»­é—®é¢˜ï¼Œå…³äºè¿™ä¸€ç‚¹å¯ä»¥äº†è§£ä¸€ä¸‹hashè¡¨å¼€æ”¾å¯»å€æ³•æŸ¥æ‰¾å…ƒç´ 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>replaceStaleEntry</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>,</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// æ–°å¢ç»“ç‚¹åˆ°Entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>sz</span> <span class=o>=</span> <span class=o>++</span><span class=n>size</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å°è¯•æ¸…é™¤åç»­hash tableä¸­çš„ç»“ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(!</span><span class=n>cleanSomeSlots</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>sz</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>sz</span> <span class=o>&gt;=</span> <span class=n>threshold</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>rehash</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ThreadLocal.get()æ–¹æ³•ä»¥åŠgetç›¸å…³æ“ä½œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å½“å‰çº¿ç¨‹å˜é‡å¯¹åº”çš„value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>public</span> <span class=n>T</span> <span class=nf>get</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å–å½“å‰è°ƒç”¨è€…çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è·å–çº¿ç¨‹ä¸­çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è·å–ThreadLocalMapä¸­çš„Entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ThreadLocalMap</span><span class=o>.</span><span class=na>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>map</span><span class=o>.</span><span class=na>getEntry</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Enrtyä¸ä¸ºç©ºæ—¶å°è¯•è·å–å¯¹åº”çš„valueï¼›
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// ä¸ºç©ºåˆ™è¡¨ç¤ºåœ¨è¿™ä¹‹å‰è¿›è¡Œè¿‡get()æ“ä½œåˆ›å»ºäº†ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=n>T</span> <span class=n>result</span> <span class=o>=</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span><span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è¿”å›é»˜è®¤å€¼ï¼Œé»˜è®¤è¿”å›null,å¯ä»¥é€šè¿‡å­ç±»é‡å†™è¯¥æ–¹æ³•ä¿®æ”¹é»˜è®¤è¿”å›å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>setInitialValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ThreadLocalMap</span> <span class=nf>getMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è¿”å›Threadä¸­çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>t</span><span class=o>.</span><span class=na>threadLocals</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ThreadLocalä¸­ç”¨æ¥å­˜å‚¨&lt;å½“å‰çº¿ç¨‹,å­˜å‚¨çš„å€¼&gt;é”®å€¼å¯¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadLocalMap</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// hashè¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>private</span> <span class=n>Entry</span><span class=o>[]</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    	<span class=c1>// è¿”å›ThreadLocalMapä¸­çš„hashè¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>private</span> <span class=n>Entry</span> <span class=nf>getEntry</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è®¡ç®— hashKey
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>table</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ä»hashTable Entry[]ä¸­è·å–å¯¹åº”çš„ThreadLocalå¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Entryå‘½ä¸­çš„æ¡ä»¶æ˜¯eå­˜åœ¨ä¸Entry &amp;&amp; eçš„å¼•ç”¨å’Œkeyç›¸åŒ
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Entryæœªå‘½ä¸­ï¼ˆeä¸å­˜åœ¨||å­˜åœ¨hashå†²çªå¯¼è‡´eçš„å¼•ç”¨å’Œkeyä¸åŒï¼‰ï¼Œå‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entryæˆ–è€…è¿”å›æœ€åä¸€ä¸ªnullç»“ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=n>getEntryAfterMiss</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>i</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç”±äºhashå†²çªå¯¼è‡´çš„æœªå‘½ä¸­ï¼Œå‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entryï¼Œæˆ–è€…
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>private</span> <span class=n>Entry</span> <span class=nf>getEntryAfterMiss</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>,</span> <span class=kt>int</span> <span class=n>i</span><span class=o>,</span> <span class=n>Entry</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>            <span class=c1>// eä¸ºç©ºå°±ç›´æ¥è¿”å›null
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// eä¸ä¸ºç©ºåˆ™å‘åå¯»æ‰¾å¯ä»¥å‘½ä¸­çš„Entry
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// hashå‘½ä¸­ï¼Œè¿”å›e
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// æ‰¾åˆ°æœ€åä¸€ä¸ªå¯ä»¥å­˜æ”¾
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>expungeStaleEntry</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿˜æ²¡æœ‰é€šè¿‡setåˆ›å»ºThreadLocalMapæ—¶ï¼Œä½¿ç”¨getæ–¹æ³•ï¼Œé»˜è®¤åˆ›å»ºä¸€ä¸ªThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the initial value
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>T</span> <span class=nf>setInitialValue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ThreadLocalç±»é»˜è®¤è¿”å›null
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>T</span> <span class=n>value</span> <span class=o>=</span> <span class=n>initialValue</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>map</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=c1>// åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadLocalMap
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>createMap</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ThreadLocalä¸­valueé»˜è®¤å€¼ï¼Œå¯ä»¥é€šè¿‡å­ç±»é‡å†™è¯¥æ–¹æ³•ä¿®æ”¹get()é»˜è®¤è¿”å›çš„å€¼
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the initial value for this thread-local
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>T</span> <span class=nf>initialValue</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>ThreadLocal.remove()æ–¹æ³•ä»¥åŠgetç›¸å…³æ“ä½œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>remove</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=n>ThreadLocalMap</span> <span class=n>m</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>());</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=o>(</span><span class=n>m</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>             <span class=n>m</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>     <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadLocalMap</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>remove</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>len</span><span class=o>-</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                 <span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                 <span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>)])</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>==</span> <span class=n>key</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=n>expungeStaleEntry</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kt>int</span> <span class=nf>expungeStaleEntry</span><span class=o>(</span><span class=kt>int</span> <span class=n>staleSlot</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>[]</span> <span class=n>tab</span> <span class=o>=</span> <span class=n>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>tab</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// æ¸…é™¤Entryä¸­staleSlotä¸‹æ ‡çš„å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>tab</span><span class=o>[</span><span class=n>staleSlot</span><span class=o>].</span><span class=na>value</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>tab</span><span class=o>[</span><span class=n>staleSlot</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// æ•´ç†hashTableï¼ˆEntryï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Entry</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>staleSlot</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                 <span class=o>(</span><span class=n>e</span> <span class=o>=</span> <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>])</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                 <span class=n>i</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>len</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>k</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>e</span><span class=o>.</span><span class=na>value</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>size</span><span class=o>--;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>len</span> <span class=o>-</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>h</span> <span class=o>!=</span> <span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>tab</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=c1>// Unlike Knuth 6.4 Algorithm R, we must scan until
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// null because multiple entries could have been stale.
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>while</span> <span class=o>(</span><span class=n>tab</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=n>h</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>h</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>tab</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>i</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h4 id=threadlocalæ€»ç»“>ThreadLocalæ€»ç»“<a hidden class=anchor aria-hidden=true href=#threadlocalæ€»ç»“>#</a></h4><ol><li>å¯¹äºä¸€ä¸ªThreadæ¥è¯´ï¼ŒThreadLocalåªæ˜¯å…¶ä¸€ä¸ªå±æ€§å˜é‡ï¼Œå…¶ä¸­ä½¿ç”¨ThreadLocalMapå­˜æ”¾äº†è¯¥çº¿ç¨‹æ‰€å­˜æ”¾çš„æ‰€æœ‰çº¿ç¨‹å˜é‡ï¼Œä¸»è¦ä»¥&lt;ThreadLocal, value>å½¢å¼å­˜å‚¨ã€‚</li><li>Threadä¸ThreadLocalæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´Threadä¸ThreadLocalMapæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</li><li>ThreadLocalä¸ºä»€ä¹ˆè¦ä½¿ç”¨ThreadLocalMap? å› ä¸ºä¸€ä¸ªThreadä¸­å¯èƒ½å­˜æ”¾å¤šä¸ªçº¿ç¨‹å˜é‡ï¼Œå­˜åœ¨ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œæ‰€ä»¥ä¸€ä¸ªThreadè¦èƒ½å¤Ÿå¯¹åº”å¤šä¸ªçº¿ç¨‹å˜é‡ï¼Œçº¿ç¨‹å˜é‡è¿˜éœ€è¦ä¸è‡ªå·±çš„valueä¸€å¯¹ä¸€å¯¹åº”ã€‚</li><li>å“ˆå¸Œå†²çªå­˜åœ¨ä¸¤ç§è§£å†³æ–¹æ³•ï¼šå¼€æ”¾å¯»å€æ³•å’Œé“¾è¡¨æ³•ã€‚ThreadLocalMapä¸­çš„Entryä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼€æ”¾å¯»å€æ³•ï¼Ÿä½¿ç”¨å¼€æ”¾å¯»å€æ³•è§£å†³å†²çªçš„æ•£ï¦œè¡¨ï¼Œè£…è½½å› å­çš„ä¸Šé™ï¥§èƒ½å¤ªå¤§ã€‚è¿™ä¹Ÿå¯¼è‡´è¿™ç§æ–¹æ³•æ¯”é“¾è¡¨æ³•ï¤æµªè´¹å†…å­˜ç©ºé—´ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œé“¾è¡¨æ³•éœ€è¦é¢å¤–çš„ç©ºé—´ï¼Œå½“ç»“ç‚¹è§„æ¨¡è¾ƒå°æ—¶ï¼Œå¼€æ”¾å¯»å€æ³•è¾ƒä¸ºèŠ‚çœç©ºé—´ã€‚å¯¹äºThreadLocalçº¿ç¨‹å˜é‡æ¥è®²ï¼Œå°†èŠ‚çœçš„æŒ‡é’ˆç©ºé—´ç”¨æ¥æ‰©å¤§æ•£åˆ—è¡¨çš„è§„æ¨¡ï¼Œå¯ä½¿è£…å¡«å› å­å˜å°ï¼Œè¿™åˆå‡å°‘äº†å¼€æ”¾å¯»å€æ³•ä¸­çš„å†²çªï¼Œä»è€Œæé«˜å¹³å‡æŸ¥æ‰¾é€Ÿåº¦ã€‚</li><li>å¯¹äºThreadLocalä¸­çš„ThreadLocalMapã€ThreadLocalMap.Entryæœ‰ç–‘é—®ï¼Œçœ‹çœ‹hashTableçš„åŸç†ï¼Œå¯ä»¥å¾ˆå¥½çš„å¸®åŠ©ç†è§£ThreadLocalã€‚</li><li>ä¸‹å›¾å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©ç†è§£ThreadLocalå˜é‡ã€ThreadLocal.ThreadLocalMapä»¥åŠEntryä¹‹é—´çš„å…³ç³»ã€‚</li></ol><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601294325514-b914afdb-9b58-47ef-81ec-af78387e8514.png><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601294325514-b914afdb-9b58-47ef-81ec-af78387e8514.png alt="ThreadLocal (3).png"></a></div></p><h3 id=inheritablethreadlocalåˆ†æ>InheritableThreadLocalåˆ†æ<a hidden class=anchor aria-hidden=true href=#inheritablethreadlocalåˆ†æ>#</a></h3><h4 id=inheritablethreadlocalä½¿ç”¨èƒŒæ™¯>InheritableThreadLocalä½¿ç”¨èƒŒæ™¯<a hidden class=anchor aria-hidden=true href=#inheritablethreadlocalä½¿ç”¨èƒŒæ™¯>#</a></h4><p>å…¶å®ä¸Šè¿°è®²è§£ThreadLocalçš„æ—¶å€™ï¼Œä½¿ç”¨åˆ°çš„ç¤ºä¾‹ä¸­å±•ç¤ºäº†ThreadLocalæ— æ³•åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¼ é€’ThreadLocalå˜é‡ã€‚ä½†æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬æ˜¯éœ€è¦å°†çˆ¶çº¿ç¨‹ä¸­çš„æŸäº›çº¿ç¨‹å˜é‡ä¼ é€’ç»™å­çº¿ç¨‹çš„ï¼Œæ¯”å¦‚çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡å­˜å‚¨ç€ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤æ—¶çˆ¶çº¿ç¨‹å¼€å¯äº†å¤šä¸ªå­çº¿ç¨‹ï¼Œå­çº¿ç¨‹éœ€è¦æŠŠç”¨æˆ·ä¿¡æ¯ä»¥åŠä¸€äº›ä¸šåŠ¡ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦æŠŠç”¨æˆ·çš„ä¿¡æ¯ä¼ é€’ç»™å­çº¿ç¨‹çš„ï¼›å¯¹äºè¿™ç§åœºæ™¯æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œæ–¹æ¡ˆä¸€å°±æ˜¯æŠŠç”¨æˆ·ä¿¡æ¯æå–ä¸ºä¸€ä¸ªæ™®é€šå±€éƒ¨å˜é‡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™å­çº¿ç¨‹çš„æ–¹æ³•ä¸­ï¼›æ–¹æ¡ˆäºŒåˆ™æ˜¯å°†ç”¨æˆ·ä¿¡æ¯ç›´æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œä½†æ˜¯å•çº¯å‡­å€ŸThreadLocalæ— æ³•å®ç°å˜é‡ä¼ é€’ï¼Œæ­¤æ—¶InheritableThreadLocalå°±å¯ä»¥å¼€å§‹å‘æŒ¥ä½œç”¨äº†ã€‚</p><h4 id=inheritablethreadlocalä½¿ç”¨å®ä¾‹>InheritableThreadLocalä½¿ç”¨å®ä¾‹<a hidden class=anchor aria-hidden=true href=#inheritablethreadlocalä½¿ç”¨å®ä¾‹>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadlocalTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>threadLocal</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InheritableThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;parent&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=s>&#34;child&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ThreadlocalTest</span><span class=o>().</span><span class=na>test</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>è¾“å‡ºç»“æœ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=n>parent</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=n>child</span>
</span></span><span class=line><span class=cl><span class=n>main</span> <span class=o>===&gt;</span> <span class=n>parent</span>
</span></span></code></pre></div><h4 id=æºç åˆ†æ-1>æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#æºç åˆ†æ-1>#</a></h4><p>å…ˆçœ‹ä¸‹InheritableThreadLocalç±»ï¼Œä»¥åŠå®ƒæ‰€é‡å†™ThreadLocalçš„setMapå’ŒgetMapæ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>InheritableThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™æµ…æ‹·è´è¿”å›çˆ¶çº¿ç¨‹æŒæœ‰çš„InheritableThreadLocal.ThreadLocalMap.Entry.valueçš„å¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=cm>     * å¦‚æœæƒ³è¦æ·±æ‹·è´valueï¼Œåˆ™éœ€è¦å­ç±»é‡å†™è¯¥æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param parentValue the parent thread&#39;s value
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the child thread&#39;s initial value
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=n>T</span> <span class=nf>childValue</span><span class=o>(</span><span class=n>T</span> <span class=n>parentValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>parentValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿”å›çº¿ç¨‹tçš„inheritableThreadLocalså˜é‡
</span></span></span><span class=line><span class=cl><span class=cm>     * ä½¿ç”¨æ—¶åˆ©ç”¨å‘ä¸‹è½¬å‹è·å–InheritableThreadLocalå˜é‡ï¼Œæ‰€ä»¥InheritableThreadLocal.get()åªä¼šè·å–å¯¹åº”çº¿ç¨‹çš„inheritableThreadLocalså˜é‡
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param t the current thread
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocalMap</span> <span class=nf>getMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=n>t</span><span class=o>.</span><span class=na>inheritableThreadLocals</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®çº¿ç¨‹tçš„inheritableThreadLocalså˜é‡
</span></span></span><span class=line><span class=cl><span class=cm>     * ä½¿ç”¨æ—¶åˆ©ç”¨å‘ä¸‹è½¬å‹è®¾ç½®InheritableThreadLocalå˜é‡ï¼Œæ‰€ä»¥InheritableThreadLocal.set()åªä¼šè®¾ç½®å¯¹åº”çº¿ç¨‹çš„inheritableThreadLocalså˜é‡
</span></span></span><span class=line><span class=cl><span class=cm>     * @param t the current thread
</span></span></span><span class=line><span class=cl><span class=cm>     * @param firstValue value for the initial entry of the table.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>createMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>,</span> <span class=n>T</span> <span class=n>firstValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=na>inheritableThreadLocals</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocalMap</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>firstValue</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>é‚£å­çº¿ç¨‹åˆæ˜¯å¦‚ä½•è·å–åˆ°çˆ¶çº¿ç¨‹çš„ThreadLocalå˜é‡å‘¢ï¼ŒæŸ¥çœ‹Threadç±»ä¸­æ–°å»ºä¸€ä¸ªçº¿ç¨‹æºç ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Thread</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * InheritableThreadLocal values pertaining to this thread. This map is
</span></span></span><span class=line><span class=cl><span class=cm>     * maintained by the InheritableThreadLocal class.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>ThreadLocalMap</span> <span class=n>inheritableThreadLocals</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Thread</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>target</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>init</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=s>&#34;Thread-&#34;</span> <span class=o>+</span> <span class=n>nextThreadNum</span><span class=o>(),</span> <span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>ThreadGroup</span> <span class=n>g</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>target</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=kt>long</span> <span class=n>stackSize</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>init</span><span class=o>(</span><span class=n>g</span><span class=o>,</span> <span class=n>target</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>stackSize</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Initializes a Thread. åˆå§‹åŒ–çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param g the Thread group
</span></span></span><span class=line><span class=cl><span class=cm>     * @param target the object whose run() method gets called
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name the name of the new Thread
</span></span></span><span class=line><span class=cl><span class=cm>     * @param stackSize the desired stack size for the new thread, or
</span></span></span><span class=line><span class=cl><span class=cm>     *        zero to indicate that this parameter is to be ignored.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param acc the AccessControlContext to inherit, or
</span></span></span><span class=line><span class=cl><span class=cm>     *            AccessController.getContext() if null
</span></span></span><span class=line><span class=cl><span class=cm>     * @param inheritThreadLocals if {@code true}, inherit initial values for
</span></span></span><span class=line><span class=cl><span class=cm>     *            inheritable thread-locals from the constructing thread æ˜¯å¦ä»è°ƒç”¨æ–¹ç»§æ‰¿InheritableThreadLocalå˜é‡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>ThreadGroup</span> <span class=n>g</span><span class=o>,</span> <span class=n>Runnable</span> <span class=n>target</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=kt>long</span> <span class=n>stackSize</span><span class=o>,</span> <span class=n>AccessControlContext</span> <span class=n>acc</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                      <span class=kt>boolean</span> <span class=n>inheritThreadLocals</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>name</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>(</span><span class=s>&#34;name cannot be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// å½“å‰è°ƒç”¨è€…çº¿ç¨‹ä¸ºçˆ¶çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Thread</span> <span class=n>parent</span> <span class=o>=</span> <span class=n>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityManager</span> <span class=n>security</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>getSecurityManager</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>g</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* Determine if it&#39;s an applet or not */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* If there is a security manager, ask the security manager
</span></span></span><span class=line><span class=cl><span class=cm>               what to do. */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>security</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>g</span> <span class=o>=</span> <span class=n>security</span><span class=o>.</span><span class=na>getThreadGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=cm>/* If the security doesn&#39;t have a strong opinion of the matter
</span></span></span><span class=line><span class=cl><span class=cm>               use the parent thread group. */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>g</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>g</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>getThreadGroup</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* checkAccess regardless of whether or not threadgroup is
</span></span></span><span class=line><span class=cl><span class=cm>           explicitly passed in. */</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=na>checkAccess</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * Do we have the required permissions?
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>security</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>isCCLOverridden</span><span class=o>(</span><span class=n>getClass</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>security</span><span class=o>.</span><span class=na>checkPermission</span><span class=o>(</span><span class=n>SUBCLASS_IMPLEMENTATION_PERMISSION</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=na>addUnstarted</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>group</span> <span class=o>=</span> <span class=n>g</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>daemon</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>isDaemon</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>getPriority</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>security</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>isCCLOverridden</span><span class=o>(</span><span class=n>parent</span><span class=o>.</span><span class=na>getClass</span><span class=o>()))</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>contextClassLoader</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>getContextClassLoader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>contextClassLoader</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=na>contextClassLoader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>inheritedAccessControlContext</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>acc</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>acc</span> <span class=o>:</span> <span class=n>AccessController</span><span class=o>.</span><span class=na>getContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>target</span> <span class=o>=</span> <span class=n>target</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>setPriority</span><span class=o>(</span><span class=n>priority</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¦‚æœinheritThreadLocals == trueï¼ˆé»˜è®¤new Threadéƒ½æ˜¯trueï¼‰å¹¶ä¸”çˆ¶çº¿ç¨‹å­˜åœ¨InheritableThreadLocalå˜é‡ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// å½“å‰çº¿ç¨‹å°†ä¼šå¤åˆ¶çˆ¶çº¿ç¨‹çš„InheritableThreadLocalåˆ°æœ¬çº¿ç¨‹ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>inheritThreadLocals</span> <span class=o>&amp;&amp;</span> <span class=n>parent</span><span class=o>.</span><span class=na>inheritableThreadLocals</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>inheritableThreadLocals</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>createInheritedMap</span><span class=o>(</span><span class=n>parent</span><span class=o>.</span><span class=na>inheritableThreadLocals</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Stash the specified stack size in case the VM cares */</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>stackSize</span> <span class=o>=</span> <span class=n>stackSize</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* Set thread ID */</span>
</span></span><span class=line><span class=cl>        <span class=n>tid</span> <span class=o>=</span> <span class=n>nextThreadID</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadLocal</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å­çº¿ç¨‹å¤åˆ¶çˆ¶çº¿ç¨‹çš„ThreadLocalå˜é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>static</span> <span class=n>ThreadLocalMap</span> <span class=nf>createInheritedMap</span><span class=o>(</span><span class=n>ThreadLocalMap</span> <span class=n>parentMap</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>ThreadLocalMap</span><span class=o>(</span><span class=n>parentMap</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>static</span> <span class=kd>class</span> <span class=nc>ThreadLocalMap</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ·±æ‹·è´ThreadLocalMap,æµ…æ‹·è´Entryä¸­çš„value
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=kd>private</span> <span class=nf>ThreadLocalMap</span><span class=o>(</span><span class=n>ThreadLocalMap</span> <span class=n>parentMap</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Entry</span><span class=o>[]</span> <span class=n>parentTable</span> <span class=o>=</span> <span class=n>parentMap</span><span class=o>.</span><span class=na>table</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>parentTable</span><span class=o>.</span><span class=na>length</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>setThreshold</span><span class=o>(</span><span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>table</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>[</span><span class=n>len</span><span class=o>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>len</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Entry</span> <span class=n>e</span> <span class=o>=</span> <span class=n>parentTable</span><span class=o>[</span><span class=n>j</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>key</span> <span class=o>=</span> <span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;)</span> <span class=n>e</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>key</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// æ‹·è´çˆ¶çº¿ç¨‹æŒæœ‰çš„InheritableThreadLocal.ThreadLocalMap.Entry.value
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// InheritableThreadLocalé»˜è®¤ä½¿ç”¨æµ…æ‹·è´ï¼ˆç›´æ¥è¿”å›å¼•ç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// å¦‚æœéœ€è¦æ·±æ‹·è´ï¼Œåˆ™éœ€è¦InheritableThreadLocalå­ç±»é‡å†™childValueæ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=n>Object</span> <span class=n>value</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>childValue</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>Entry</span> <span class=n>c</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// è®¡ç®—ä¸‹ä¸€ä¸ªhashä¸‹æ ‡
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=na>threadLocalHashCode</span> <span class=o>&amp;</span> <span class=o>(</span><span class=n>len</span> <span class=o>-</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>while</span> <span class=o>(</span><span class=n>table</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                            <span class=n>h</span> <span class=o>=</span> <span class=n>nextIndex</span><span class=o>(</span><span class=n>h</span><span class=o>,</span> <span class=n>len</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>table</span><span class=o>[</span><span class=n>h</span><span class=o>]</span> <span class=o>=</span> <span class=n>c</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>size</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h4 id=inheritablethreadlocal-æ‹·è´æœºåˆ¶>InheritableThreadLocal æ‹·è´æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#inheritablethreadlocal-æ‹·è´æœºåˆ¶>#</a></h4><p><div class=post-img-view><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601358479593-10e7d145-bfa5-46d9-9b42-9d724168e054.png><img src=https://cdn.jsdelivr.net/gh/luolin1024/image@main/img/1601358479593-10e7d145-bfa5-46d9-9b42-9d724168e054.png alt=InheritableThreadLocal.png></a></div>InheritableThreadLocalä¸ThreadLocalçš„åŒºåˆ«å°±åœ¨äºçˆ¶çº¿ç¨‹å¯ä»¥å°†InheritableThreadLocalå˜é‡æ·±æ‹·è´ä¸€ä»½åˆ°å­çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯Entryä¸­çš„vaueåˆ™æ˜¯æµ…æ‹·è´ï¼Œä¹Ÿå°±æ˜¯è¯´å‡å¦‚å­çº¿ç¨‹é€šè¿‡get()æ–¹æ³•è·å–åˆ°å¯¹åº”çš„valueä¹‹åï¼Œç›´æ¥ä¿®æ”¹valueçš„å€¼ï¼Œçˆ¶çº¿ç¨‹ä¸­è·å–åˆ°çš„valueçš„å€¼ä¹Ÿä¼šè¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadlocalTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Person</span><span class=o>&gt;</span> <span class=n>threadLocal</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InheritableThreadLocal</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>threadLocal</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>new</span> <span class=n>Person</span><span class=o>(</span><span class=s>&#34;a&#34;</span><span class=o>,</span> <span class=mi>13</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Thread</span> <span class=n>thread</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toString</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;===&gt;&#34;</span> <span class=o>+</span><span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>hashCode</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>setAge</span><span class=o>(</span><span class=mi>15</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toString</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;===&gt;&#34;</span> <span class=o>+</span><span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>hashCode</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>thread</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; ===&gt; &#34;</span> <span class=o>+</span> <span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toString</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;===&gt;&#34;</span> <span class=o>+</span><span class=n>threadLocal</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>hashCode</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>threadLocal</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>ThreadlocalTest</span><span class=o>().</span><span class=na>test</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>è¾“å‡ºç»“æœï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=n>Person</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=sc>&#39;a&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=mi>13</span><span class=o>}===&gt;</span><span class=mi>2024651980</span>
</span></span><span class=line><span class=cl><span class=n>Thread</span><span class=o>-</span><span class=mi>0</span> <span class=o>===&gt;</span> <span class=n>Person</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=sc>&#39;a&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=mi>15</span><span class=o>}===&gt;</span><span class=mi>2024651980</span>
</span></span><span class=line><span class=cl><span class=n>main</span> <span class=o>===&gt;</span> <span class=n>Person</span><span class=o>{</span><span class=n>name</span><span class=o>=</span><span class=sc>&#39;a&#39;</span><span class=o>,</span> <span class=n>age</span><span class=o>=</span><span class=mi>15</span><span class=o>}===&gt;</span><span class=mi>2024651980</span>
</span></span></code></pre></div><p>åœ¨å­çº¿ç¨‹ä¸­ä¿®æ”¹äº†get()è·å–åˆ°çš„valueä¸­çš„å±æ€§å€¼ï¼Œçˆ¶çº¿ç¨‹é€šè¿‡get()è·å–åˆ°çš„valueä¹Ÿå‘ç”Ÿäº†æ”¹å˜ï¼Œä¸”çˆ¶å­çº¿ç¨‹ä¸­get()è·å–åˆ°çš„valueçš„åœ°å€æ˜¯ç›¸åŒçš„ã€‚</p><h4 id=inheritablethreadlocalæ€»ç»“>InheritableThreadLocalæ€»ç»“<a hidden class=anchor aria-hidden=true href=#inheritablethreadlocalæ€»ç»“>#</a></h4><ol><li>ç›¸æ¯”è¾ƒThreadLocalï¼ŒInheritableThreadLocalå®Œæˆäº†çˆ¶å­çº¿ç¨‹ä¹‹é—´çº¿ç¨‹å˜é‡çš„ä¼ é€’ï¼Œå®ç°æ–¹æ¡ˆæ˜¯çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™ï¼Œçˆ¶çº¿ç¨‹æœ¬èº«æ–°å»ºäº†ä¸€ä¸ªInheritableThreadLocalå˜é‡å­˜æ”¾inheritableThreadLocalsä¸­ï¼Œå­çº¿ç¨‹ä»çˆ¶çº¿ç¨‹æ‹·è´inheritableThreadLocalså±æ€§ï¼Œè€ŒInheritableThreadLocalç»§æ‰¿è‡ªThreadLocalï¼Œä½¿å¾—å…¶å®Œç¾æ‰¿è½½äº†ThreadLocalçš„å±æ€§ï¼Œåªæ˜¯é‡å†™å…¶ä¸­çš„setMapå’ŒgetMapæ–¹æ³•åä½¿å¾—å…¶è¿”å›çš„mapä¸ºçº¿ç¨‹çš„inheritableThreadLocalså˜é‡ã€‚</li><li>çˆ¶çº¿ç¨‹æ–°å»ºå­çº¿ç¨‹çš„æ—¶å€™ï¼ŒThreadLocalMapæ˜¯æ·±æ‹·è´ï¼Œä½†æ˜¯Entryä¸­çš„valueæ˜¯æµ…æ‹·è´ï¼Œä¹Ÿå°±æ„å‘³ç€å­çº¿ç¨‹é€šè¿‡get()è·å–åˆ°çš„valueä¿®æ”¹ä¹‹åï¼Œçˆ¶çº¿ç¨‹å†é€šè¿‡get()è·å–valueä¹Ÿæ˜¯ä¿®æ”¹è¿‡åçš„ã€‚</li></ol><h3 id=æ€è€ƒ>æ€è€ƒ<a hidden class=anchor aria-hidden=true href=#æ€è€ƒ>#</a></h3><p>ç›®å‰å·²ç»å¾ˆå°‘å‡ºç°é€šè¿‡è‡ªå·±æ‰‹åŠ¨new Threadå¯åŠ¨çº¿ç¨‹äº†ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ThreadPoolå®ç°ã€‚åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹æ± æ˜¯å¤ç”¨çº¿ç¨‹ï¼Œä¸ä¼šé‡å¤åˆ›å»ºï¼Œè€ŒInheritableThreadLocalæ˜¯åœ¨åˆ›å»ºå­çº¿ç¨‹çš„æ—¶å€™æ‰ä¼šå°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶åˆ°å­çº¿ç¨‹ä¸­ï¼Œä½†æ˜¯çº¿ç¨‹æ± ä¸ä¼šé‡å¤åˆ›å»ºï¼Œæ‰€ä»¥å¤šæ¬¡ä½¿ç”¨åï¼Œä»ç„¶è®°å½•çš„æ˜¯ç¬¬ä¸€æ¬¡æäº¤ä»»åŠ¡æ—¶çš„å¤–éƒ¨çº¿ç¨‹çš„å€¼ï¼Œä¼šé€ æˆæ•°æ®çš„é”™è¯¯ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://luolin1024.github.io/tags/java/java%E5%9F%BA%E7%A1%80/>Java/JavaåŸºç¡€</a></li><li><a href=https://luolin1024.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>æºç åˆ†æ</a></li></ul><nav class=paginav><a class=prev href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E6%95%B0%E6%8D%AE%E5%BA%93/sql%E8%81%94%E8%A1%A8%E6%9F%A5%E8%AF%A2/><span class=title>Â« Prev</span><br><span>Sqlè”è¡¨æŸ¥è¯¢</span></a>
<a class=next href=https://luolin1024.github.io/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/uml-unified-modeling-language/><span class=title>Next Â»</span><br><span>UMLç»Ÿä¸€å»ºæ¨¡è¯­è¨€</span></a></nav><div class=related-posts><h2>ç›¸å…³æ–‡ç« </h2><ul><li>Â· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/java%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%BB%93%E5%90%88threadlocal%E7%9A%84%E7%94%A8%E6%B3%95%E5%AE%9E%E4%BE%8B/>Javaçº¿ç¨‹æ± ç»“åˆThreadLocalçš„ç”¨æ³•å®ä¾‹</a></li><li>Â· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/object%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>Objectæºç åˆ†æ</a></li><li>Â· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/spring/spring5-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/>Spring5 æºç é˜…è¯»ç¯å¢ƒæ­å»º</a></li><li>Â· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/java-%E5%8F%8D%E5%B0%84/>Java-åå°„</a></li><li>Â· <a href=/blog_prepublish/%E6%8A%80%E6%9C%AF%E6%8F%90%E5%8D%87/java/java8-stream/>Java8 Stream</a></li></ul></div></footer><link rel=stylesheet href=https://unpkg.com/@waline/client@v2/dist/waline.css><div id=waline></div><script type=module>
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
    const locale = {
        nick: 'æ˜µç§°',
        nickError: 'è¯·å¡«å†™æ˜µç§°',
        mail: 'é‚®ç®±',
        mailError: 'è¯·å¡«å†™æ­£ç¡®çš„é‚®ä»¶åœ°å€',
        link: 'ç½‘å€',
        optional: 'å¯é€‰',
        placeholder: 'ä»…å¡«å†™æ˜µç§°å³å¯å‘è¡¨å›å¤ã€‚\nå¡«å†™é‚®ç®±å¯æ”¶åˆ°å›å¤æé†’ã€‚\nè¯„è®ºåŒºæ”¯æŒ Markdown è¯­æ³•åŠé¢„è§ˆã€‚\n',
        sofa: 'æ¥å‘è¯„è®ºå§~',
        submit: 'æäº¤',
        like: 'å–œæ¬¢',
        cancelLike: 'å–æ¶ˆå–œæ¬¢',
        reply: 'å›å¤',
        cancelReply: 'å–æ¶ˆå›å¤',
        comment: 'è¯„è®º',
        refresh: 'åˆ·æ–°',
        more: 'åŠ è½½æ›´å¤š...',
        preview: 'é¢„è§ˆ',
        emoji: 'è¡¨æƒ…',
        uploadImage: 'ä¸Šä¼ å›¾ç‰‡',
        seconds: 'ç§’å‰',
        minutes: 'åˆ†é’Ÿå‰',
        hours: 'å°æ—¶å‰',
        days: 'å¤©å‰',
        now: 'åˆšåˆš',
        uploading: 'æ­£åœ¨ä¸Šä¼ ',
        login: 'ç®¡ç†',
        logout: 'é€€å‡º',
        admin: 'åšä¸»',
        sticky: 'ç½®é¡¶',
        word: 'å­—',
        wordHint: 'è¯„è®ºå­—æ•°åº”åœ¨ $0 åˆ° $1 å­—ä¹‹é—´ï¼\nå½“å‰å­—æ•°ï¼š$2',
        anonymous: 'åŒ¿å',
        level0: 'æ½œæ°´',
        level1: 'å†’æ³¡',
        level2: 'åæ§½',
        level3: 'æ´»è·ƒ',
        level4: 'è¯ç—¨',
        level5: 'ä¼ è¯´',
        gif: 'è¡¨æƒ…åŒ…',
        gifSearchPlaceholder: 'æœç´¢è¡¨æƒ…åŒ…',
        profile: 'ä¸ªäººèµ„æ–™',
        approved: 'é€šè¿‡',
        waiting: 'å¾…å®¡æ ¸',
        spam: 'åƒåœ¾',
        unsticky: 'å–æ¶ˆç½®é¡¶',
        oldest: 'æŒ‰å€’åº',
        latest: 'æŒ‰æ­£åº',
        hottest: 'æŒ‰çƒ­åº¦',
        reactionTitle: 'ä½ è®¤ä¸ºè¿™ç¯‡æ–‡ç« æ€ä¹ˆæ ·ï¼Ÿ',
    };
    init({
        
        el: '#waline',
        serverURL: 'https://blogcomments.luolin.online',
        locale,
        emoji: false,     
        search: false,    
        reaction: false,  
        requiredMeta: ['nick'],
        pageSize: 10,
        imageUploader: false,
        copyright: true,
        pageview: true,
        like: false,
    });
</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://luolin1024.github.io>luolin1024</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div>æœ¬ç«™æ€»è®¿é—®é‡ <span id=umami_value_site_pv></span> æ¬¡
æœ¬ç«™æ€»è®¿å®¢æ•° <span id=umami_value_site_uv></span> äºº
å½“å‰åœ¨çº¿è®¿å®¢ <span id=umami_value_active_uv></span> äºº</div><a href="https://icp.gov.moe/?keyword=20248618" target=_blank>èŒICPå¤‡20248618å·</a></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>